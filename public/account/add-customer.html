<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New Customer | Building Group | Customer Management System</title>
    <meta name="description" content="Add new customers to Building Group customer management system. Create customer profiles with contact details, preferences, and project history tracking.">
    <meta name="keywords" content="add customer, customer management, building clients, construction customers, client database">
    <meta name="author" content="Building Group">
    <meta name="robots" content="noindex, nofollow">
    

    <!-- Favicon -->
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- Last Updated -->
    <meta name="last-modified" content="2025-07-19T12:19:09Z">
    
    <style>
        /* Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* Enhanced Theme System - CSS Variables */
        :root {
            --primary-color: #e74c3c;
            --primary-dark: #c0392b;
            --primary-light: #ec7063;
            --secondary-color: #3498db;
            --accent-color: #f39c12;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #17a2b8;
            --text-color: #2c3e50;
            --text-secondary: #6c757d;
            --text-light: #95a5a6;
            --background-color: #f8fafc;
            --background-secondary: #ecf0f1;
            --card-background: #ffffff;
            --input-background: #ffffff;
            --border-color: #dee2e6;
            --border-light: #f1f3f4;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.15);
            --shadow-xl: 0 16px 64px rgba(0,0,0,0.2);
            --gradient-primary: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            --gradient-secondary: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
            --gradient-success: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            --gradient-customers: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }
        
        /* Dark Theme Variables */
        [data-theme="dark"] {
            --text-color: #ffffff;
            --text-secondary: #bdc3c7;
            --text-light: #95a5a6;
            --background-color: #0f0f0f;
            --background-secondary: #1a1a1a;
            --card-background: #1e1e1e;
            --input-background: #2a2a2a;
            --border-color: #333333;
            --border-light: #2a2a2a;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
            --shadow-xl: 0 16px 64px rgba(0,0,0,0.6);
        }
        
        /* Auto Theme Detection */
        @media (prefers-color-scheme: dark) {
            :root[data-theme="auto"] {
                --text-color: #ffffff;
                --text-secondary: #bdc3c7;
                --text-light: #95a5a6;
                --background-color: #0f0f0f;
                --background-secondary: #1a1a1a;
                --card-background: #1e1e1e;
                --input-background: #2a2a2a;
                --border-color: #333333;
                --border-light: #2a2a2a;
                --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
                --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
                --shadow-lg: 0 8px 32px rgba(0,0,0,0.5);
                --shadow-xl: 0 16px 64px rgba(0,0,0,0.6);
            }
        }
        
        /* Base Elements */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background: var(--background-color);
            min-height: 100vh;
            transition: all 0.3s ease;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        /* Header */
        .header {
            background: var(--card-background);
            box-shadow: var(--shadow-md);
            padding: 1rem 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .back-btn {
            background: var(--background-secondary);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }
        
        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-color);
        }
        
        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .theme-toggle {
            background: var(--background-secondary);
            color: var(--text-color);
            border: 2px solid var(--border-color);
            padding: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .theme-toggle:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: var(--text-color);
            font-weight: 500;
        }
        
        .user-avatar {
            width: 35px;
            height: 35px;
            border-radius: 50%;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }
        
        /* Main Content */
        .main-content {
            padding: 2rem 0;
        }
        
        .page-header {
            text-align: center;
            margin-bottom: 3rem;
        }
        
        .page-title {
            font-size: 2.5rem;
            font-weight: 800;
            color: var(--text-color);
            margin-bottom: 0.5rem;
        }
        
        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        /* Customer Form */
        .customer-form-container {
            background: var(--card-background);
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            max-width: 800px;
            margin: 0 auto;
        }
        
        .form-header {
            background: var(--gradient-customers);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .form-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .form-header p {
            opacity: 0.9;
        }
        
        .customer-form {
            padding: 2rem;
        }
        
        .form-section {
            margin-bottom: 2.5rem;
            padding: 1.5rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background: var(--background-secondary);
        }
        
        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .section-icon {
            width: 35px;
            height: 35px;
            background: var(--gradient-customers);
            color: white;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }
        
        .form-row-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-row-3 {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
        }
        
        .form-label.required::after {
            content: '*';
            color: var(--danger-color);
            margin-left: 3px;
        }
        
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 0.875rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--input-background);
            color: var(--text-color);
            transition: all 0.3s ease;
            outline: none;
        }
        
        .form-input:focus, .form-select:focus, .form-textarea:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(231, 76, 60, 0.1);
            transform: translateY(-1px);
        }
        
        .form-input:valid, .form-select:valid {
            border-color: var(--success-color);
        }
        
        .form-textarea {
            resize: vertical;
            min-height: 100px;
        }
        
        .form-help {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Customer Type Selection */
        .customer-type-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 0.5rem;
        }
        
        .type-option {
            position: relative;
        }
        
        .type-radio {
            position: absolute;
            opacity: 0;
            pointer-events: none;
        }
        
        .type-label {
            display: block;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 600;
            font-size: 0.9rem;
            background: var(--card-background);
        }
        
        .type-radio:checked + .type-label {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .type-label.residential {
            border-color: var(--success-color);
            color: var(--success-color);
        }
        
        .type-radio:checked + .type-label.residential {
            background: var(--success-color);
            border-color: var(--success-color);
        }
        
        .type-label.commercial {
            border-color: var(--info-color);
            color: var(--info-color);
        }
        
        .type-radio:checked + .type-label.commercial {
            background: var(--info-color);
            border-color: var(--info-color);
        }
        
        .type-label.contractor {
            border-color: var(--warning-color);
            color: var(--warning-color);
        }
        
        .type-radio:checked + .type-label.contractor {
            background: var(--warning-color);
            border-color: var(--warning-color);
        }
        
        /* Rating Stars */
        .rating-stars {
            display: flex;
            gap: 0.25rem;
            margin-top: 0.5rem;
        }
        
        .star {
            font-size: 1.5rem;
            color: var(--border-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .star:hover,
        .star.active {
            color: var(--warning-color);
            transform: scale(1.1);
        }
        
        /* Alert Messages */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            font-size: 0.9rem;
            font-weight: 500;
            display: none;
            animation: slideInDown 0.3s ease;
        }
        
        .alert.show {
            display: block;
        }
        
        .alert-success {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(39, 174, 96, 0.2);
        }
        
        .alert-error {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(231, 76, 60, 0.2);
        }
        
        .alert-warning {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(243, 156, 18, 0.2);
        }
        
        .alert-info {
            background: rgba(23, 162, 184, 0.1);
            color: var(--info-color);
            border: 1px solid rgba(23, 162, 184, 0.2);
        }
        
        /* Form Actions */
        .form-actions {
            margin-top: 3rem;
            padding: 2rem;
            background: var(--background-secondary);
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        .btn {
            padding: 0.875rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            text-align: center;
            justify-content: center;
            min-width: 140px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }
        
        .btn-customers {
            background: var(--gradient-customers);
            color: white;
        }
        
        .btn-secondary {
            background: var(--background-color);
            color: var(--text-color);
            border: 2px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background: var(--background-secondary);
            border-color: var(--primary-color);
        }
        
        .btn:disabled {
            background: var(--text-light) !important;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }
        
        .btn-loading {
            pointer-events: none;
            opacity: 0.8;
        }
        
        .btn-loading .spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 0.5rem;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Customer Summary */
        .customer-summary {
            background: var(--card-background);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            display: none;
        }
        
        .summary-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .summary-item {
            text-align: center;
            padding: 1rem;
            background: var(--background-secondary);
            border-radius: 8px;
        }
        
        .summary-value {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 0.25rem;
        }
        
        .summary-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Collections Setup Preview */
        .collections-preview {
            background: var(--background-secondary);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1rem;
        }
        
        .collections-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .collections-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        .collection-item {
            background: var(--card-background);
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .collection-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }
        
        .collection-icon {
            font-size: 1.8rem;
            margin-bottom: 0.5rem;
        }
        
        .collection-icon.jobs {
            color: var(--primary-color);
        }
        
        .collection-icon.invoices {
            color: var(--success-color);
        }
        
        .collection-icon.quotes {
            color: var(--warning-color);
        }
        
        .collection-name {
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.9rem;
        }
        
        .collection-desc {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
        }
        
        /* Animations */
        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.5s ease;
        }
        
        /* Enhanced Responsive Design */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .page-title {
                font-size: 2rem;
            }
            
            .form-row-2, .form-row-3 {
                grid-template-columns: 1fr;
            }
            
            .form-actions {
                flex-direction: column;
                text-align: center;
            }
            
            .customer-type-selector {
                grid-template-columns: 1fr;
            }
            
            .summary-grid, .collections-grid {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .customer-form {
                padding: 1rem;
            }
            
            .form-section {
                padding: 1rem;
            }
            
            .container {
                padding: 0 0.5rem;
            }
        }
        
        /* High Contrast Mode Support */
        @media (prefers-contrast: high) {
            :root {
                --border-color: #000000;
                --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
            }
            
            [data-theme="dark"] {
                --border-color: #ffffff;
                --shadow-md: 0 4px 12px rgba(255,255,255,0.3);
            }
        }
        
        /* Reduced Motion Support */
        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
            }
        }
        
        /* Focus Styles for Accessibility */
        *:focus-visible {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="header-left">
                    <a href="/account/my-dash.html" class="back-btn">
                        <i class="fas fa-arrow-left"></i>
                        Back to Dashboard
                    </a>
                    <h1 class="header-title">Add New Customer</h1>
                </div>
                
                <div class="header-right">
                    <button class="theme-toggle" id="themeToggle" title="Toggle Theme">
                        <i class="fas fa-moon"></i>
                    </button>
                    <div class="user-info">
                        <div class="user-avatar" id="userAvatar">DL</div>
                        <span id="userName">Dad-Link</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <!-- Page Header -->
            <div class="page-header">
                <h2 class="page-title">Add New Customer</h2>
                <p class="page-subtitle">
                    Create a comprehensive customer profile with contact details, preferences, and project history.
                    Each customer gets their own dedicated collections for jobs and invoices.
                </p>
            </div>

            <!-- Alert Messages -->
            <div class="alert alert-error" id="errorAlert" role="alert"></div>
            <div class="alert alert-success" id="successAlert" role="alert"></div>
            <div class="alert alert-warning" id="warningAlert" role="alert"></div>
            <div class="alert alert-info" id="infoAlert" role="alert"></div>

            <!-- Customer Form Container -->
            <div class="customer-form-container">
                <div class="form-header">
                    <h3>Customer Registration Form</h3>
                    <p>Complete all details to create a comprehensive customer profile</p>
                </div>

                <form class="customer-form" id="customerForm" novalidate>
                    <!-- Personal Information -->
                    <div class="form-section">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            Personal Information
                        </div>

                        <div class="form-row-2">
                            <div class="form-group">
                                <label for="firstName" class="form-label required">First Name</label>
                                <input
                                    type="text"
                                    id="firstName"
                                    name="firstName"
                                    class="form-input"
                                    placeholder="Customer's first name"
                                    required
                                    autocomplete="given-name"
                                    maxlength="50"
                                >
                            </div>
                            <div class="form-group">
                                <label for="lastName" class="form-label required">Last Name</label>
                                <input
                                    type="text"
                                    id="lastName"
                                    name="lastName"
                                    class="form-input"
                                    placeholder="Customer's last name"
                                    required
                                    autocomplete="family-name"
                                    maxlength="50"
                                >
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="company" class="form-label">Company/Organization</label>
                            <input
                                type="text"
                                id="company"
                                name="company"
                                class="form-input"
                                placeholder="Company name (if applicable)"
                                autocomplete="organization"
                                maxlength="100"
                            >
                            <div class="form-help">Optional - for business customers</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Customer Type</label>
                            <div class="customer-type-selector">
                                <div class="type-option">
                                    <input type="radio" id="typeResidential" name="customerType" value="residential" class="type-radio" checked>
                                    <label for="typeResidential" class="type-label residential">
                                        <i class="fas fa-home"></i><br>
                                        Residential
                                    </label>
                                </div>
                                <div class="type-option">
                                    <input type="radio" id="typeCommercial" name="customerType" value="commercial" class="type-radio">
                                    <label for="typeCommercial" class="type-label commercial">
                                        <i class="fas fa-building"></i><br>
                                        Commercial
                                    </label>
                                </div>
                                <div class="type-option">
                                    <input type="radio" id="typeContractor" name="customerType" value="contractor" class="type-radio">
                                    <label for="typeContractor" class="type-label contractor">
                                        <i class="fas fa-hard-hat"></i><br>
                                        Contractor
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Contact Information -->
                    <div class="form-section">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            Contact Information
                        </div>

                        <div class="form-row-2">
                            <div class="form-group">
                                <label for="email" class="form-label required">Email Address</label>
                                <input
                                    type="email"
                                    id="email"
                                    name="email"
                                    class="form-input"
                                    placeholder="customer@example.com"
                                    required
                                    autocomplete="email"
                                >
                            </div>
                            <div class="form-group">
                                <label for="phone" class="form-label required">Primary Phone</label>
                                <input
                                    type="tel"
                                    id="phone"
                                    name="phone"
                                    class="form-input"
                                    placeholder="01234 567890"
                                    required
                                    autocomplete="tel"
                                >
                            </div>
                        </div>

                        <div class="form-row-2">
                            <div class="form-group">
                                <label for="alternatePhone" class="form-label">Alternate Phone</label>
                                <input
                                    type="tel"
                                    id="alternatePhone"
                                    name="alternatePhone"
                                    class="form-input"
                                    placeholder="Secondary contact number"
                                    autocomplete="tel"
                                >
                            </div>
                            <div class="form-group">
                                <label for="preferredContact" class="form-label">Preferred Contact Method</label>
                                <select
                                    id="preferredContact"
                                    name="preferredContact"
                                    class="form-select"
                                >
                                    <option value="">Select preference</option>
                                    <option value="email">Email</option>
                                    <option value="phone">Phone Call</option>
                                    <option value="text">Text Message</option>
                                    <option value="whatsapp">WhatsApp</option>
                                    <option value="any">Any Method</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Address Information -->
                    <div class="form-section">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            Address Information
                        </div>

                        <div class="form-group">
                            <label for="address" class="form-label required">Primary Address</label>
                            <textarea
                                id="address"
                                name="address"
                                class="form-textarea"
                                placeholder="Enter complete address including postcode"
                                required
                                rows="3"
                                maxlength="500"
                            ></textarea>
                            <div class="form-help">This will be the main address for jobs and invoices</div>
                        </div>

                        <div class="form-row-3">
                            <div class="form-group">
                                <label for="city" class="form-label">City/Town</label>
                                <input
                                    type="text"
                                    id="city"
                                    name="city"
                                    class="form-input"
                                    placeholder="Manchester"
                                    maxlength="50"
                                >
                            </div>
                            <div class="form-group">
                                <label for="postcode" class="form-label required">Postcode</label>
                                <input
                                    type="text"
                                    id="postcode"
                                    name="postcode"
                                    class="form-input"
                                    placeholder="M1 1AA"
                                    required
                                    pattern="[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]? [0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}"
                                    maxlength="10"
                                >
                            </div>
                            <div class="form-group">
                                <label for="serviceArea" class="form-label">Service Area</label>
                                <select
                                    id="serviceArea"
                                    name="serviceArea"
                                    class="form-select"
                                >
                                    <option value="">Auto-detect from postcode</option>
                                    <option value="manchester">Manchester</option>
                                    <option value="liverpool">Liverpool</option>
                                    <option value="leeds">Leeds</option>
                                    <option value="cheshire">Cheshire</option>
                                    <option value="stockport">Stockport</option>
                                    <option value="bolton">Bolton</option>
                                    <option value="warrington">Warrington</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="alternateAddress" class="form-label">Alternate/Billing Address</label>
                            <textarea
                                id="alternateAddress"
                                name="alternateAddress"
                                class="form-textarea"
                                placeholder="Different address for billing/correspondence (optional)"
                                rows="2"
                                maxlength="500"
                            ></textarea>
                            <div class="form-help">Leave blank if same as primary address</div>
                        </div>
                    </div>

                    <!-- Business Preferences -->
                    <div class="form-section">
                        <div class="section-title">
                            <div class="section-icon">
                                <i class="fas fa-cogs"></i>
                            </div>
                            Business Preferences
                        </div>

                        <div class="form-row-2">
                            <div class="form-group">
                                <label for="leadSource" class="form-label">How did they find us?</label>
                                <select
                                    id="leadSource"
                                    name="leadSource"
                                    class="form-select"
                                >
                                    <option value="">Select source</option>
                                    <option value="website">Website</option>
                                    <option value="google">Google Search</option>
                                    <option value="facebook">Facebook</option>
                                    <option value="referral">Referral</option>
                                    <option value="repeat-customer">Repeat Customer</option>
                                    <option value="local-ad">Local Advertisement</option>
                                    <option value="word-of-mouth">Word of Mouth</option>
                                    <option value="trade-directory">Trade Directory</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="paymentPreference" class="form-label">Payment Preference</label>
                                <select
                                    id="paymentPreference"
                                    name="paymentPreference"
                                    class="form-select"
                                >
                                    <option value="">Select preference</option>
                                    <option value="bank-transfer">Bank Transfer</option>
                                    <option value="cash">Cash</option>
                                    <option value="cheque">Cheque</option>
                                    <option value="card">Card Payment</option>
                                    <option value="finance">Finance Options</option>
                                    <option value="flexible">Flexible</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Customer Rating</label>
                            <div class="rating-stars" id="customerRating">
                                <span class="star" data-rating="1">★</span>
                                <span class="star" data-rating="2">★</span>
                                <span class="star" data-rating="3">★</span>
                                <span class="star" data-rating="4">★</span>
                                <span class="star" data-rating="5">★</span>
                            </div>
                            <input type="hidden" id="rating" name="rating" value="0">
                            <div class="form-help">Rate based on previous interactions or initial impression</div>
                        </div>

                        <div class="form-group">
                            <label for="notes" class="form-label">Customer Notes</label>
                            <textarea
                                id="notes"
                                name="notes"
                                class="form-textarea"
                                placeholder="Important notes about the customer, preferences, special requirements, etc."
                                rows="4"
                                maxlength="1000"
                            ></textarea>
                            <div class="form-help">Internal notes visible to your team only</div>
                        </div>
                    </div>

                    <!-- Collections Setup Preview -->
                    <div class="collections-preview">
                        <div class="collections-title">
                            <i class="fas fa-database"></i>
                            Customer Collections
                        </div>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem; font-size: 0.9rem;">
                            The following collections will be created for this customer:
                        </p>
                        
                        <div class="collections-grid">
                            <div class="collection-item">
                                <div class="collection-icon jobs">
                                    <i class="fas fa-hammer"></i>
                                </div>
                                <div class="collection-name">Jobs</div>
                                <div class="collection-desc">All construction projects</div>
                            </div>
                            
                            <div class="collection-item">
                                <div class="collection-icon invoices">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="collection-name">Invoices</div>
                                <div class="collection-desc">Billing & payments</div>
                            </div>
                            
                            <div class="collection-item">
                                <div class="collection-icon quotes">
                                    <i class="fas fa-file-alt"></i>
                                </div>
                                <div class="collection-name">Quotes</div>
                                <div class="collection-desc">Price estimates</div>
                            </div>
                        </div>
                    </div>

                    <!-- Customer Summary -->
                    <div class="customer-summary" id="customerSummary">
                        <div class="summary-title">
                            <i class="fas fa-user-chart"></i>
                            Customer Summary
                        </div>
                        <div class="summary-grid">
                            <div class="summary-item">
                                <div class="summary-value" id="summaryType">Residential</div>
                                <div class="summary-label">Customer Type</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="summaryArea">Manchester</div>
                                <div class="summary-label">Service Area</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="summaryContact">Email</div>
                                <div class="summary-label">Preferred Contact</div>
                            </div>
                            <div class="summary-item">
                                <div class="summary-value" id="summaryRating">★★★★★</div>
                                <div class="summary-label">Initial Rating</div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions">
                        <div>
                            <button type="button" class="btn btn-secondary" id="saveDraft">
                                <i class="fas fa-save"></i>
                                Save Draft
                            </button>
                        </div>
                        <div style="display: flex; gap: 1rem;">
                            <button type="button" class="btn btn-secondary" id="previewCustomer">
                                <i class="fas fa-eye"></i>
                                Preview
                            </button>
                            <button type="submit" class="btn btn-customers" id="createCustomer">
                                <i class="fas fa-user-plus"></i>
                                Create Customer
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </main>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBI1M38HZH8-xY3nfoKmqoitmggq3C8zKE",
            authDomain: "buildinggroup-4f8b9.firebaseapp.com",
            projectId: "buildinggroup-4f8b9",
            storageBucket: "buildinggroup-4f8b9.firebasestorage.app",
            messagingSenderId: "353000992011",
            appId: "1:353000992011:web:c834310d7d79dd1bf0c60e",
            measurementId: "G-DF11Q5PZRT"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        
        // Global variables
        let currentUser = null;
        let customerRating = 0;
        
        // Theme Management
        const themeToggle = document.getElementById('themeToggle');
        const html = document.documentElement;
        
        let currentTheme = localStorage.getItem('theme') || 'auto';
        html.setAttribute('data-theme', currentTheme);
        updateThemeIcon();
        
        themeToggle.addEventListener('click', () => {
            switch(currentTheme) {
                case 'auto':
                    currentTheme = 'light';
                    break;
                case 'light':
                    currentTheme = 'dark';
                    break;
                case 'dark':
                    currentTheme = 'auto';
                    break;
            }
            
            html.setAttribute('data-theme', currentTheme);
            localStorage.setItem('theme', currentTheme);
            updateThemeIcon();
        });
        
        function updateThemeIcon() {
            const icon = themeToggle.querySelector('i');
            switch(currentTheme) {
                case 'light':
                    icon.className = 'fas fa-sun';
                    break;
                case 'dark':
                    icon.className = 'fas fa-moon';
                    break;
                case 'auto':
                    icon.className = 'fas fa-adjust';
                    break;
            }
        }
        
        // Alert Functions
        function showAlert(type, message) {
            hideAllAlerts();
            const alert = document.getElementById(`${type}Alert`);
            alert.textContent = message;
            alert.classList.add('show');
            
            setTimeout(() => {
                alert.classList.remove('show');
            }, 8000);
        }
        
        function hideAllAlerts() {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => alert.classList.remove('show'));
        }
        
        // User Authentication Check
        function checkAuthState() {
            return new Promise((resolve) => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    unsubscribe();
                    if (user && user.emailVerified) {
                        currentUser = user;
                        loadUserData();
                        resolve(true);
                    } else {
                        showAlert('error', 'Please login to access this page');
                        setTimeout(() => {
                            window.location.href = '/account/login.html';
                        }, 2000);
                        resolve(false);
                    }
                });
            });
        }
        
        async function loadUserData() {
            try {
                const userDoc = await db.collection('users').doc(currentUser.uid).get();
                if (userDoc.exists) {
                    const userData = userDoc.data();
                    
                    // Update UI
                    document.getElementById('userName').textContent = userData.firstName || 'User';
                    document.getElementById('userAvatar').textContent = (userData.firstName?.[0] || 'U') + (userData.lastName?.[0] || '');
                }
            } catch (error) {
                console.error('Error loading user data:', error);
            }
        }
        
        // Rating System
        const stars = document.querySelectorAll('.star');
        const ratingInput = document.getElementById('rating');
        
        stars.forEach((star, index) => {
            star.addEventListener('click', () => {
                customerRating = index + 1;
                ratingInput.value = customerRating;
                updateStars(customerRating);
                updateCustomerSummary();
            });
            
            star.addEventListener('mouseover', () => {
                updateStars(index + 1);
            });
        });
        
        document.getElementById('customerRating').addEventListener('mouseleave', () => {
            updateStars(customerRating);
        });
        
        function updateStars(rating) {
            stars.forEach((star, index) => {
                if (index < rating) {
                    star.classList.add('active');
                } else {
                    star.classList.remove('active');
                }
            });
        }
        
        // Customer Summary Updates
        function updateCustomerSummary() {
            const customerType = document.querySelector('input[name="customerType"]:checked')?.value || 'residential';
            const serviceArea = document.getElementById('serviceArea').value || 'manchester';
            const preferredContact = document.getElementById('preferredContact').value || 'email';
            const rating = customerRating;
            
            document.getElementById('summaryType').textContent = customerType.charAt(0).toUpperCase() + customerType.slice(1);
            document.getElementById('summaryArea').textContent = serviceArea.charAt(0).toUpperCase() + serviceArea.slice(1);
            document.getElementById('summaryContact').textContent = preferredContact.charAt(0).toUpperCase() + preferredContact.slice(1);
            document.getElementById('summaryRating').textContent = '★'.repeat(rating) + '☆'.repeat(5 - rating);
            
            // Show summary if there's content
            if (customerType || serviceArea || preferredContact || rating) {
                document.getElementById('customerSummary').style.display = 'block';
            }
        }
        
        // Form Validation
        function validateForm() {
            const required = [
                'firstName',
                'lastName',
                'email',
                'phone',
                'address',
                'postcode'
            ];
            
            for (const fieldId of required) {
                const field = document.getElementById(fieldId);
                if (!field.value.trim()) {
                    showAlert('error', `${field.previousElementSibling.textContent.replace('*', '').trim()} is required`);
                    field.focus();
                    return false;
                }
            }
            
            // Validate email
            const email = document.getElementById('email').value;
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                showAlert('error', 'Please enter a valid email address');
                document.getElementById('email').focus();
                return false;
            }
            
            // Validate UK postcode
            const postcode = document.getElementById('postcode').value;
            const postcodeRegex = /^[A-Za-z]{1,2}[0-9Rr][0-9A-Za-z]?\s?[0-9][ABD-HJLNP-UW-Zabd-hjlnp-uw-z]{2}$/;
            if (!postcodeRegex.test(postcode.replace(/\s/g, ''))) {
                showAlert('error', 'Please enter a valid UK postcode');
                document.getElementById('postcode').focus();
                return false;
            }
            
            return true;
        }
        
        // Check for duplicate customers
        async function checkDuplicateCustomer(email, phone) {
            try {
                const emailQuery = await db.collection('users').doc(currentUser.uid)
                    .collection('customers')
                    .where('email', '==', email.toLowerCase())
                    .get();
                
                const phoneQuery = await db.collection('users').doc(currentUser.uid)
                    .collection('customers')
                    .where('phone', '==', phone)
                    .get();
                
                if (!emailQuery.empty) {
                    return { duplicate: true, type: 'email', customer: emailQuery.docs[0].data() };
                }
                
                if (!phoneQuery.empty) {
                    return { duplicate: true, type: 'phone', customer: phoneQuery.docs[0].data() };
                }
                
                return { duplicate: false };
                
            } catch (error) {
                console.error('Error checking duplicate customer:', error);
                return { duplicate: false };
            }
        }
        
        // Collect Form Data
        function collectFormData() {
            const form = document.getElementById('customerForm');
            const formData = new FormData(form);
            
            // Generate customer ID
            const customerId = generateCustomerId();
            
            // Build customer data
            const customerData = {
                // Customer ID and metadata
                customerId: customerId,
                customerNumber: generateCustomerNumber(),
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                createdBy: currentUser.uid,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Personal information
                firstName: formData.get('firstName').trim(),
                lastName: formData.get('lastName').trim(),
                fullName: `${formData.get('firstName').trim()} ${formData.get('lastName').trim()}`,
                company: formData.get('company')?.trim() || null,
                customerType: formData.get('customerType') || 'residential',
                
                // Contact information
                email: formData.get('email').toLowerCase().trim(),
                phone: formData.get('phone').trim(),
                alternatePhone: formData.get('alternatePhone')?.trim() || null,
                preferredContact: formData.get('preferredContact') || 'email',
                
                // Address information
                address: formData.get('address').trim(),
                city: formData.get('city')?.trim() || null,
                postcode: formData.get('postcode').toUpperCase().trim(),
                serviceArea: formData.get('serviceArea') || detectServiceArea(formData.get('postcode')),
                alternateAddress: formData.get('alternateAddress')?.trim() || null,
                
                // Business preferences
                leadSource: formData.get('leadSource') || null,
                paymentPreference: formData.get('paymentPreference') || null,
                rating: parseInt(formData.get('rating')) || 0,
                notes: formData.get('notes')?.trim() || null,
                
                // Status and tracking
                status: 'active',
                isActive: true,
                totalJobs: 0,
                completedJobs: 0,
                totalSpent: 0,
                lastJobDate: null,
                lastContactDate: firebase.firestore.FieldValue.serverTimestamp(),
                
                // Collections counters
                invoicesCount: 0,
                quotesCount: 0,
                jobsCount: 0,
                
                // Search indexing
                searchTerms: [
                    formData.get('firstName').toLowerCase(),
                    formData.get('lastName').toLowerCase(),
                    formData.get('email').toLowerCase(),
                    formData.get('company')?.toLowerCase(),
                    formData.get('phone'),
                    formData.get('postcode').toLowerCase()
                ].filter(term => term && term.trim())
            };
            
            return customerData;
        }
        
        function generateCustomerId() {
            return 'CUST_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
        }
        
        function generateCustomerNumber() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const time = String(now.getTime()).slice(-4);
            
            return `CUST-${year}${month}${day}-${time}`;
        }
        
        function detectServiceArea(postcode) {
            const pc = postcode.toUpperCase().replace(/\s/g, '');
            
            // Manchester postcodes
            if (/^M[0-9]/.test(pc)) return 'manchester';
            
            // Liverpool postcodes
            if (/^L[0-9]/.test(pc)) return 'liverpool';
            
            // Leeds postcodes
            if (/^LS[0-9]/.test(pc)) return 'leeds';
            
            // Cheshire postcodes
            if (/^CW[0-9]|^WA[0-9]|^SK[0-9]/.test(pc)) return 'cheshire';
            
            // Stockport
            if (/^SK[0-9]/.test(pc)) return 'stockport';
            
            // Bolton
            if (/^BL[0-9]/.test(pc)) return 'bolton';
            
            // Warrington
            if (/^WA[0-9]/.test(pc)) return 'warrington';
            
            return 'other';
        }
        
        // Create Customer Collections
        async function createCustomerCollections(customerId) {
            const collections = ['jobs', 'invoices', 'quotes'];
            
            try {
                for (const collectionName of collections) {
                    await db.collection('users').doc(currentUser.uid)
                        .collection('customers').doc(customerId)
                        .collection(collectionName).doc('_init').set({
                            created: firebase.firestore.FieldValue.serverTimestamp(),
                            note: `${collectionName} collection initialized for customer`,
                            customerId: customerId,
                            isEmpty: true
                        });
                }
                
                return true;
            } catch (error) {
                console.error('Error creating customer collections:', error);
                throw error;
            }
        }
        
        // Save Customer to Firebase
        async function saveCustomerToFirebase(customerData, isDraft = false) {
            try {
                if (isDraft) {
                    customerData.isDraft = true;
                    customerData.status = 'draft';
                }
                
                // Check for duplicates
                const duplicateCheck = await checkDuplicateCustomer(customerData.email, customerData.phone);
                
                if (duplicateCheck.duplicate && !isDraft) {
                    throw new Error(`Customer already exists with the same ${duplicateCheck.type}: ${duplicateCheck.customer.fullName}`);
                }
                
                // Save customer document
                const docRef = await db.collection('users').doc(currentUser.uid)
                    .collection('customers').add(customerData);
                
                // Create customer subcollections
                if (!isDraft) {
                    await createCustomerCollections(docRef.id);
                }
                
                return docRef.id;
                
            } catch (error) {
                console.error('Error saving customer:', error);
                throw error;
            }
        }
        
        // Update form listeners for summary
        ['customerType', 'serviceArea', 'preferredContact'].forEach(name => {
            const elements = document.querySelectorAll(`[name="${name}"]`);
            elements.forEach(element => {
                element.addEventListener('change', updateCustomerSummary);
            });
        });
        
        // Phone number formatting
        ['phone', 'alternatePhone'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                
                // UK phone number formatting
                if (value.startsWith('44')) {
                    value = '+44 ' + value.slice(2, 5) + ' ' + value.slice(5, 8) + ' ' + value.slice(8);
                } else if (value.startsWith('0')) {
                    value = value.slice(0, 5) + ' ' + value.slice(5, 8) + ' ' + value.slice(8);
                }
                
                this.value = value;
            });
        });
        
        // Postcode formatting and service area detection
        document.getElementById('postcode').addEventListener('blur', function() {
            let postcode = this.value.toUpperCase().replace(/\s/g, '');
            
            // Format postcode
            if (postcode.length >= 5) {
                postcode = postcode.slice(0, -3) + ' ' + postcode.slice(-3);
            }
            
            this.value = postcode;
            
            // Auto-detect service area
            const serviceArea = detectServiceArea(postcode);
            const serviceAreaSelect = document.getElementById('serviceArea');
            if (serviceArea !== 'other' && !serviceAreaSelect.value) {
                serviceAreaSelect.value = serviceArea;
                updateCustomerSummary();
            }
        });
        
        // Email domain suggestions
        document.getElementById('email').addEventListener('blur', function() {
            const email = this.value.toLowerCase();
            const commonDomains = ['gmail.com', 'outlook.com', 'yahoo.com', 'hotmail.com'];
            const typos = {
                'gmial.com': 'gmail.com',
                'gmai.com': 'gmail.com',
                'outlok.com': 'outlook.com',
                'yahooo.com': 'yahoo.com'
            };
            
            if (email.includes('@')) {
                const domain = email.split('@')[1];
                if (typos[domain]) {
                    const correctedEmail = email.replace(domain, typos[domain]);
                    if (confirm(`Did you mean "${correctedEmail}"?`)) {
                        this.value = correctedEmail;
                    }
                }
            }
        });
        
        // Save Draft
        document.getElementById('saveDraft').addEventListener('click', async function() {
            const button = this;
            button.classList.add('btn-loading');
            button.innerHTML = '<div class="spinner"></div>Saving Draft...';
            button.disabled = true;
            
            try {
                if (!currentUser) {
                    showAlert('error', 'Please login to save customer');
                    return;
                }
                
                const customerData = collectFormData();
                const customerId = await saveCustomerToFirebase(customerData, true);
                
                showAlert('success', `Customer draft saved successfully! Customer Number: ${customerData.customerNumber}`);
                
                // Store draft ID for later use
                localStorage.setItem('lastCustomerDraftId', customerId);
                
            } catch (error) {
                console.error('Error saving draft:', error);
                showAlert('error', 'Failed to save draft. Please try again.');
            } finally {
                button.classList.remove('btn-loading');
                button.innerHTML = '<i class="fas fa-save"></i>Save Draft';
                button.disabled = false;
            }
        });
        
        // Preview Customer
        document.getElementById('previewCustomer').addEventListener('click', function() {
            if (!validateForm()) return;
            
            const customerData = collectFormData();
            showCustomerPreview(customerData);
        });
        
        function showCustomerPreview(customerData) {
            const previewContent = `
                <div style="background: var(--card-background); padding: 2rem; border-radius: 12px; max-width: 600px; margin: 2rem auto; box-shadow: var(--shadow-lg);">
                    <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid var(--border-color);">
                        <h2 style="color: var(--primary-color); margin-bottom: 0.5rem;">${customerData.fullName}</h2>
                        <p style="color: var(--text-secondary);">Customer Number: ${customerData.customerNumber}</p>
                        <div style="margin-top: 1rem;">
                            <span style="background: var(--${customerData.customerType === 'residential' ? 'success' : customerData.customerType === 'commercial' ? 'info' : 'warning'}-color); color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;">
                                ${customerData.customerType.toUpperCase()}
                            </span>
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.2rem;">Contact Details</h3>
                            <p><strong>Email:</strong> ${customerData.email}</p>
                            <p><strong>Phone:</strong> ${customerData.phone}</p>
                            ${customerData.alternatePhone ? `<p><strong>Alt Phone:</strong> ${customerData.alternatePhone}</p>` : ''}
                            <p><strong>Preferred Contact:</strong> ${customerData.preferredContact}</p>
                            ${customerData.company ? `<p><strong>Company:</strong> ${customerData.company}</p>` : ''}
                        </div>
                        <div>
                            <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.2rem;">Location</h3>
                            <p><strong>Service Area:</strong> ${customerData.serviceArea.charAt(0).toUpperCase() + customerData.serviceArea.slice(1)}</p>
                            <p><strong>Postcode:</strong> ${customerData.postcode}</p>
                            ${customerData.city ? `<p><strong>City:</strong> ${customerData.city}</p>` : ''}
                            <p><strong>Rating:</strong> ${'★'.repeat(customerData.rating)}${'☆'.repeat(5 - customerData.rating)} (${customerData.rating}/5)</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.2rem;">Address</h3>
                        <div style="background: var(--background-secondary); padding: 1rem; border-radius: 8px; line-height: 1.6;">
                            ${customerData.address.replace(/\n/g, '<br>')}
                        </div>
                        ${customerData.alternateAddress ? `
                        <div style="margin-top: 1rem;">
                            <strong>Alternate Address:</strong><br>
                            <div style="background: var(--background-secondary); padding: 1rem; border-radius: 8px; line-height: 1.6; margin-top: 0.5rem;">
                                ${customerData.alternateAddress.replace(/\n/g, '<br>')}
                            </div>
                        </div>` : ''}
                    </div>
                    
                    ${customerData.leadSource || customerData.paymentPreference ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.2rem;">Preferences</h3>
                        ${customerData.leadSource ? `<p><strong>Lead Source:</strong> ${customerData.leadSource}</p>` : ''}
                        ${customerData.paymentPreference ? `<p><strong>Payment Preference:</strong> ${customerData.paymentPreference}</p>` : ''}
                    </div>` : ''}
                    
                    ${customerData.notes ? `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: var(--text-color); margin-bottom: 1rem; font-size: 1.2rem;">Notes</h3>
                        <div style="background: var(--background-secondary); padding: 1rem; border-radius: 8px; line-height: 1.6;">
                            ${customerData.notes.replace(/\n/g, '<br>')}
                        </div>
                    </div>` : ''}
                    
                    <div style="background: var(--info-bg); color: var(--info-text); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                        <strong>Collections to be created:</strong><br>
                        • Jobs collection for all construction projects<br>
                        • Invoices collection for billing and payments<br>
                        • Quotes collection for price estimates
                    </div>
                    
                    <div style="text-align: center; margin-top: 2rem;">
                        <button onclick="closeCustomerPreview()" style="background: var(--primary-color); color: white; border: none; padding: 0.75rem 2rem; border-radius: 8px; cursor: pointer; font-weight: 600;">Close Preview</button>
                    </div>
                </div>
            `;
            
            // Create preview overlay
            const overlay = document.createElement('div');
            overlay.id = 'customerPreviewOverlay';
            overlay.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0,0,0,0.8);
                z-index: 9999;
                overflow-y: auto;
                padding: 2rem 1rem;
            `;
            overlay.innerHTML = previewContent;
            
            document.body.appendChild(overlay);
            
            // Close on overlay click
            overlay.addEventListener('click', function(e) {
                if (e.target === overlay) {
                    closeCustomerPreview();
                }
            });
        }
        
        window.closeCustomerPreview = function() {
            const overlay = document.getElementById('customerPreviewOverlay');
            if (overlay) {
                overlay.remove();
            }
        };
        
        // Create Customer (Main Submit)
        document.getElementById('customerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            if (!validateForm()) return;
            
            const button = document.getElementById('createCustomer');
            button.classList.add('btn-loading');
            button.innerHTML = '<div class="spinner"></div>Creating Customer...';
            button.disabled = true;
            
            try {
                if (!currentUser) {
                    showAlert('error', 'Please login to create customer');
                    return;
                }
                
                const customerData = collectFormData();
                const customerId = await saveCustomerToFirebase(customerData, false);
                
                showAlert('success', `Customer created successfully! Customer Number: ${customerData.customerNumber}`);
                
                // Store success data
                localStorage.setItem('lastCreatedCustomer', JSON.stringify({
                    customerId: customerId,
                    customerNumber: customerData.customerNumber,
                    customerName: customerData.fullName,
                    email: customerData.email,
                    createdAt: new Date().toISOString()
                }));
                
                // Show success with collections info
                setTimeout(() => {
                    showAlert('info', 'Customer collections (Jobs, Invoices, Quotes) have been initialized successfully!');
                }, 2000);
                
                // Clear form or redirect
                setTimeout(() => {
                    if (confirm('Customer created successfully! Would you like to create another customer?')) {
                        // Reset form
                        document.getElementById('customerForm').reset();
                        customerRating = 0;
                        updateStars(0);
                        document.getElementById('customerSummary').style.display = 'none';
                        hideAllAlerts();
                        window.scrollTo(0, 0);
                        document.getElementById('firstName').focus();
                    } else {
                        // Redirect to dashboard or customers list
                        window.location.href = '/account/my-dash.html';
                    }
                }, 4000);
                
            } catch (error) {
                console.error('Error creating customer:', error);
                showAlert('error', error.message || 'Failed to create customer. Please try again.');
            } finally {
                button.classList.remove('btn-loading');
                button.innerHTML = '<i class="fas fa-user-plus"></i>Create Customer';
                button.disabled = false;
            }
        });
        
        // Auto-save functionality
        let autoSaveTimeout;
        
        function autoSaveDraft() {
            clearTimeout(autoSaveTimeout);
            autoSaveTimeout = setTimeout(async () => {
                if (!currentUser) return;
                
                try {
                    const customerData = collectFormData();
                    
                    // Only auto-save if there's meaningful content
                    if (customerData.firstName || customerData.email) {
                        const existingDraftId = localStorage.getItem('autoSaveCustomerDraftId');
                        
                        if (existingDraftId) {
                            // Update existing draft
                            await db.collection('users').doc(currentUser.uid)
                                .collection('customers').doc(existingDraftId).update({
                                    ...customerData,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    isAutoSave: true
                                });
                        } else {
                            // Create new auto-save draft
                            const docRef = await db.collection('users').doc(currentUser.uid)
                                .collection('customers').add({
                                    ...customerData,
                                    isDraft: true,
                                    isAutoSave: true,
                                    status: 'draft'
                                });
                            localStorage.setItem('autoSaveCustomerDraftId', docRef.id);
                        }
                        
                        console.log('Auto-saved customer draft');
                    }
                } catch (error) {
                    console.error('Auto-save error:', error);
                }
            }, 30000); // Auto-save every 30 seconds
        }
        
        // Add auto-save listeners to key fields
        document.querySelectorAll('input, select, textarea').forEach(field => {
            field.addEventListener('input', autoSaveDraft);
            field.addEventListener('change', autoSaveDraft);
        });
        
        // Load draft if exists
        async function loadExistingDraft() {
            const draftId = localStorage.getItem('autoSaveCustomerDraftId');
            if (!draftId || !currentUser) return;
            
            try {
                const draftDoc = await db.collection('users').doc(currentUser.uid)
                    .collection('customers').doc(draftId).get();
                
                if (draftDoc.exists && draftDoc.data().isDraft) {
                    const shouldLoad = confirm('We found a saved customer draft. Would you like to load it?');
                    if (shouldLoad) {
                        const draftData = draftDoc.data();
                        populateFormFromData(draftData);
                        showAlert('info', 'Customer draft loaded successfully');
                    }
                }
            } catch (error) {
                console.error('Error loading draft:', error);
            }
        }
        
        function populateFormFromData(data) {
            // Personal information
            document.getElementById('firstName').value = data.firstName || '';
            document.getElementById('lastName').value = data.lastName || '';
            document.getElementById('company').value = data.company || '';
            
            if (data.customerType) {
                document.querySelector(`input[name="customerType"][value="${data.customerType}"]`).checked = true;
            }
            
            // Contact information
            document.getElementById('email').value = data.email || '';
            document.getElementById('phone').value = data.phone || '';
            document.getElementById('alternatePhone').value = data.alternatePhone || '';
            document.getElementById('preferredContact').value = data.preferredContact || '';
            
            // Address information
            document.getElementById('address').value = data.address || '';
            document.getElementById('city').value = data.city || '';
            document.getElementById('postcode').value = data.postcode || '';
            document.getElementById('serviceArea').value = data.serviceArea || '';
            document.getElementById('alternateAddress').value = data.alternateAddress || '';
            
            // Business preferences
            document.getElementById('leadSource').value = data.leadSource || '';
            document.getElementById('paymentPreference').value = data.paymentPreference || '';
            document.getElementById('notes').value = data.notes || '';
            
            // Rating
            if (data.rating) {
                customerRating = data.rating;
                document.getElementById('rating').value = customerRating;
                updateStars(customerRating);
            }
            
            updateCustomerSummary();
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl+S to save draft
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                document.getElementById('saveDraft').click();
            }
            
            // Ctrl+Enter to create customer
            if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                e.preventDefault();
                if (validateForm()) {
                    document.getElementById('createCustomer').click();
                }
            }
            
            // Escape to clear current field
            if (e.key === 'Escape') {
                if (document.activeElement && document.activeElement.tagName === 'INPUT') {
                    document.activeElement.value = '';
                }
            }
        });
        
        // Customer type specific features
        document.querySelectorAll('input[name="customerType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const type = this.value;
                const companyField = document.getElementById('company');
                const companyLabel = companyField.previousElementSibling;
                
                if (type === 'commercial' || type === 'contractor') {
                    companyLabel.textContent = 'Company/Organization *';
                    companyLabel.classList.add('required');
                    companyField.required = true;
                } else {
                    companyLabel.textContent = 'Company/Organization';
                    companyLabel.classList.remove('required');
                    companyField.required = false;
                }
                
                updateCustomerSummary();
            });
        });
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Add Customer Page Loaded - 2025-07-19T12:25:32Z');
            console.log('Current User: Dad-Link');
            
            // Check authentication
            const isAuthenticated = await checkAuthState();
            if (!isAuthenticated) return;
            
            // Load existing draft if available
            setTimeout(() => {
                loadExistingDraft();
            }, 1000);
            
            // Focus first field
            document.getElementById('firstName').focus();
            
            console.log('🚀 Add Customer System Ready!');
            console.log('✓ Firebase Integration ✓ Form Validation ✓ Auto-save');
            console.log('✓ Collections Creation ✓ Duplicate Detection ✓ Draft System');
            console.log('✓ Rating System ✓ Preview Feature ✓ Service Area Detection');
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', function(e) {
            // Save draft if there's content
            const hasContent = document.getElementById('firstName').value ||
                              document.getElementById('email').value;
            
            if (hasContent && currentUser) {
                // Quick auto-save attempt
                autoSaveDraft();
            }
        });
        
        // Performance monitoring
        function trackFormPerformance() {
            const loadTime = performance.now();
            console.log(`Add Customer form loaded in: ${loadTime.toFixed(2)}ms`);
            
            // Track form completion time
            let formStartTime = Date.now();
            let fieldsCompleted = 0;
            
            document.querySelectorAll('input, select, textarea').forEach(field => {
                field.addEventListener('focus', function() {
                    if (fieldsCompleted === 0) {
                        formStartTime = Date.now();
                    }
                });
                
                field.addEventListener('blur', function() {
                    if (this.value.trim()) {
                        fieldsCompleted++;
                    }
                });
            });
            
            document.getElementById('createCustomer').addEventListener('click', function() {
                const completionTime = Date.now() - formStartTime;
                console.log(`Customer form completion time: ${completionTime}ms`);
                console.log(`Fields completed: ${fieldsCompleted}`);
            });
        }
        
        // Enhanced duplicate checking with suggestions
        async function checkAndSuggestSimilarCustomers(firstName, lastName, email) {
            try {
                const nameQuery = await db.collection('users').doc(currentUser.uid)
                    .collection('customers')
                    .where('searchTerms', 'array-contains', firstName.toLowerCase())
                    .get();
                
                const similarCustomers = [];
                nameQuery.forEach(doc => {
                    const data = doc.data();
                    if (data.lastName.toLowerCase().includes(lastName.toLowerCase()) ||
                        data.email.toLowerCase().includes(email.toLowerCase())) {
                        similarCustomers.push({
                            id: doc.id,
                            name: data.fullName,
                            email: data.email,
                            phone: data.phone
                        });
                    }
                });
                
                if (similarCustomers.length > 0) {
                    const names = similarCustomers.map(c => c.name).join(', ');
                    showAlert('warning', `Similar customers found: ${names}. Please verify this is a new customer.`);
                }
                
            } catch (error) {
                console.error('Error checking similar customers:', error);
            }
        }
        
        // Check for similar customers when name is entered
        document.getElementById('lastName').addEventListener('blur', function() {
            const firstName = document.getElementById('firstName').value.trim();
            const lastName = this.value.trim();
            const email = document.getElementById('email').value.trim();
            
            if (firstName && lastName) {
                setTimeout(() => {
                    checkAndSuggestSimilarCustomers(firstName, lastName, email);
                }, 500);
            }
        });
        
        trackFormPerformance();
        
        console.log('👥 Building Group Add Customer System Initialized!');
        console.log('📋 Features Ready: Customer Management, Collections Creation, Contact Tracking');
        console.log('💾 Auto-save: Every 30 seconds | 🔄 Draft Recovery: Available');
        console.log('📊 Integration: Firebase Firestore with subcollections');
        console.log('🏗️ Collections: Jobs, Invoices, Quotes per customer');
        console.log('👤 User: Dad-Link');
        console.log('⏰ Timestamp: 2025-07-19T12:25:32Z');
    </script>
</body>
</html>
