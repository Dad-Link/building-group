<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice Details | Building Group</title>
  <meta name="description" content="View and manage a single invoice. Mark as paid, record payments, send, print, and download PDF.">
  <meta name="robots" content="noindex, nofollow">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval'
      https://www.gstatic.com
      https://www.googleapis.com
      https://apis.google.com
      https://cdn.jsdelivr.net;
    connect-src 'self'
      https://identitytoolkit.googleapis.com
      https://www.googleapis.com
      https://securetoken.googleapis.com
      https://buildinggroup-4f8b9-default-rtdb.firebaseio.com
      https://firestore.googleapis.com
      https://buildinggroup-4f8b9.firebasestorage.app
      https://www.gstatic.com
      https://*.gstatic.com;
    img-src 'self' data:
      https://www.gstatic.com
      https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com
      https://cdnjs.cloudflare.com;
    font-src 'self'
      https://fonts.gstatic.com
      https://cdnjs.cloudflare.com;
    frame-src 'self' https://buildinggroup-4f8b9.firebaseapp.com;
  ">

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- PDF generator -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-color:#e74c3c;--primary-dark:#c0392b;--secondary:#3498db;
      --success:#27ae60;--warning:#f39c12;--danger:#e74c3c;--info:#17a2b8;
      --text:#2c3e50;--muted:#6c757d;--bg:#f8fafc;--bg-2:#ecf0f1;--card:#fff;
      --border:#dee2e6;--border-light:#f1f3f4;--shadow:0 4px 12px rgba(0,0,0,.1);
      --shadow-lg:0 8px 32px rgba(0,0,0,.15)
    }
    [data-theme="dark"]{
      --text:#fff;--muted:#bdc3c7;--bg:#0f0f0f;--bg-2:#1a1a1a;--card:#1e1e1e;--border:#333;--border-light:#2a2a2a
    }
    @media (prefers-color-scheme: dark){
      :root[data-theme="auto"]{
        --text:#fff;--muted:#bdc3c7;--bg:#0f0f0f;--bg-2:#1a1a1a;--card:#1e1e1e;--border:#333;--border-light:#2a2a2a
      }
    }
    body{font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:1.75rem 1rem}
    .header{background:var(--card);box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:1rem 1.25rem}
    .back-btn{background:var(--bg-2);border:1px solid var(--border);color:var(--text);text-decoration:none;border-radius:8px;padding:.55rem .9rem;display:inline-flex;gap:.5rem;align-items:center;font-weight:700}
    .back-btn:hover{background:var(--primary-color);border-color:var(--primary-color);color:#fff;transform:translateY(-1px)}
    .h-title{font-size:1.4rem;font-weight:800}
    .right{display:flex;align-items:center;gap:.6rem}
    .theme-toggle{background:var(--bg-2);border:1px solid var(--border);color:var(--text);width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center}
    .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#e74c3c,#c0392b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}

    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
    .btn{border:none;border-radius:8px;padding:.6rem .9rem;font-weight:800;display:inline-flex;align-items:center;gap:.45rem;cursor:pointer}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-secondary{background:var(--bg-2);color:var(--text);border:1px solid var(--border)}
    .btn-success{background:linear-gradient(135deg,#27ae60,#229954);color:#fff}
    .btn-info{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
    .btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .alert{display:none;margin:1rem 0;padding:1rem;border-radius:10px;font-weight:700}
    .alert.show{display:block}
    .alert-success{background:rgba(39,174,96,.12);color:var(--success);border:1px solid rgba(39,174,96,.25)}
    .alert-error{background:rgba(231,76,60,.12);color:var(--danger);border:1px solid rgba(231,76,60,.25)}
    .alert-info{background:rgba(52,152,219,.12);color:#2980b9;border:1px solid rgba(52,152,219,.25)}

    .loading{display:flex;justify-content:center;align-items:center;min-height:40vh}
    .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:1.25rem;margin:1rem 0}
    .title-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:flex-start;justify-content:space-between}
    .invoice-title{font-size:1.8rem;font-weight:900}
    .subtle{color:var(--muted);font-weight:600}
    .badge{display:inline-block;padding:.35rem .7rem;border-radius:999px;font-weight:900;font-size:.8rem;letter-spacing:.4px;text-transform:uppercase}
    .badge.draft{background:rgba(243,156,18,.12);color:var(--warning)}
    .badge.pending{background:rgba(52,152,219,.12);color:#2980b9}
    .badge.sent{background:rgba(52,152,219,.12);color:#2980b9}
    .badge.paid{background:rgba(39,174,96,.12);color:var(--success)}
    .badge.overdue{background:rgba(231,76,60,.12);color:var(--danger)}
    .badge.cancelled{background:rgba(149,165,166,.12);color:#95a5a6}

    .meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.8rem;margin-top:1rem}
    .meta-box{background:var(--bg-2);border-radius:12px;padding:.9rem;text-align:center}
    .meta-val{font-size:1.15rem;font-weight:900;color:var(--primary-color)}
    .meta-lbl{font-size:.85rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-top:.2rem}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media(max-width:900px){.two-col{grid-template-columns:1fr}}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:.5rem;background:var(--bg-2);border-radius:10px;padding:.6rem .75rem;margin:.4rem 0}
    .kv .k{font-weight:900;color:var(--muted)}
    .kv .v{font-weight:700}

    table{width:100%;border-collapse:collapse}
    th,td{padding:.7rem;border-bottom:1px solid var(--border-light);text-align:left}
    th{background:var(--bg-2);font-size:.85rem;text-transform:uppercase;letter-spacing:.4px}
    .right{text-align:right}
    .totals{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem;margin-top:1rem}
    .tbox{background:var(--bg-2);border-radius:10px;padding:.8rem;text-align:center}
    .t-lbl{font-size:.8rem;color:var(--muted);text-transform:uppercase}
    .t-val{font-size:1.15rem;font-weight:900;color:var(--primary-color)}

    .paylist{margin-top:.5rem}
    .payitem{display:grid;grid-template-columns:1fr 120px 160px 1fr;gap:.6rem;background:var(--bg-2);border-radius:10px;padding:.6rem .75rem;margin:.4rem 0}
    @media(max-width:720px){.payitem{grid-template-columns:1fr 1fr}}
    .muted{color:var(--muted)}

    @media print{
      .header,.toolbar,.alert{display:none !important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #eee;border-radius:0}
      .container{max-width:100%;padding:0}
    }
    *:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-inner">
      <div style="display:flex;align-items:center;gap:.75rem">
        <a href="/account/invoices.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Invoices</a>
        <div class="h-title subtle" id="headerSmall">Invoice</div>
      </div>
      <div class="right">
        <button class="theme-toggle" id="themeToggle" title="Toggle theme"><i class="fas fa-moon"></i></button>
        <div class="avatar" id="userAvatar">--</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Alerts -->
    <div class="alert alert-success" id="okAlert"></div>
    <div class="alert alert-error" id="errAlert"></div>
    <div class="alert alert-info" id="infoAlert"></div>

    <!-- Loading -->
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <!-- Content -->
    <div id="content" style="display:none">
      <!-- Title + actions -->
      <div class="card" id="printHeader">
        <div class="title-row">
          <div>
            <div class="invoice-title" id="invTitle">Invoice</div>
            <div class="subtle" id="invSub">INV-0000 â€¢ Created -</div>
          </div>
          <div>
            <span class="badge" id="statusBadge">pending</span>
          </div>
        </div>

        <div class="toolbar" style="margin-top:.9rem">
          <button class="btn btn-primary" id="editBtn"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn btn-success" id="markPaidBtn"><i class="fas fa-check-circle"></i> Mark as Paid</button>
          <button class="btn btn-info" id="markSentBtn"><i class="fas fa-paper-plane"></i> Mark as Sent</button>
          <button class="btn btn-secondary" id="newPaymentBtn"><i class="fas fa-coins"></i> Record Payment</button>
          <button class="btn btn-secondary" id="downloadBtn"><i class="fas fa-file-pdf"></i> Download PDF</button>
          <button class="btn btn-secondary" id="printBtn"><i class="fas fa-print"></i> Print</button>
          <button class="btn btn-danger" id="deleteBtn"><i class="fas fa-trash"></i> Delete</button>
        </div>

        <div class="meta-grid">
          <div class="meta-box">
            <div class="meta-val" id="amountMeta">Â£0</div>
            <div class="meta-lbl">Invoice Total</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="balanceMeta">Â£0</div>
            <div class="meta-lbl">Balance Due</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="createdMeta">-</div>
            <div class="meta-lbl">Created</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="dueMeta">Not set</div>
            <div class="meta-lbl">Due Date</div>
          </div>
        </div>
      </div>

      <!-- Parties -->
      <div class="two-col">
        <div class="card">
          <div style="font-weight:900;margin-bottom:.5rem"><i class="fas fa-file-invoice"></i> Invoice</div>
          <div class="kv"><div class="k">Number</div><div class="v" id="invNumber">-</div></div>
          <div class="kv"><div class="k">Status</div><div class="v" id="invStatus">-</div></div>
          <div class="kv"><div class="k">Job</div><div class="v" id="jobInfo">-</div></div>
          <div class="kv"><div class="k">Reference</div><div class="v" id="reference">-</div></div>
        </div>
        <div class="card">
          <div style="font-weight:900;margin-bottom:.5rem"><i class="fas fa-user"></i> Billed To</div>
          <div class="kv"><div class="k">Name</div><div class="v" id="custName">-</div></div>
          <div class="kv"><div class="k">Email</div><div class="v" id="custEmail">-</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v" id="custPhone">-</div></div>
          <div class="kv"><div class="k">Address</div><div class="v" id="custAddress">-</div></div>
        </div>
      </div>

      <!-- Items -->
      <div class="card">
        <div style="font-weight:900;margin-bottom:.6rem"><i class="fas fa-list-ul"></i> Items</div>
        <div id="itemsEmpty" class="muted" style="margin-bottom:.6rem">No line items. Using invoice amount.</div>
        <div class="table-wrap">
          <table id="itemsTable" style="display:none">
            <thead>
              <tr>
                <th style="min-width:220px">Item</th>
                <th style="min-width:260px">Description</th>
                <th class="right" style="width:110px">Qty</th>
                <th class="right" style="width:140px">Rate (Â£)</th>
                <th class="right" style="width:140px">Total (Â£)</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
        <div class="totals">
          <div class="tbox">
            <div class="t-lbl">Subtotal</div>
            <div class="t-val" id="subtotalVal">Â£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Tax</div>
            <div class="t-val" id="taxVal">Â£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Total</div>
            <div class="t-val" id="totalVal">Â£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Paid</div>
            <div class="t-val" id="paidVal">Â£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Balance</div>
            <div class="t-val" id="balanceVal">Â£0</div>
          </div>
        </div>
      </div>

      <!-- Payments -->
      <div class="card">
        <div style="font-weight:900;margin-bottom:.6rem"><i class="fas fa-coins"></i> Payments</div>
        <div id="paymentsEmpty" class="muted">No payments recorded.</div>
        <div class="paylist" id="paymentsList"></div>
      </div>

      <!-- Notes -->
      <div class="card">
        <div style="font-weight:900;margin-bottom:.6rem"><i class="fas fa-sticky-note"></i> Notes</div>
        <div id="notesBox" class="muted">None</div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBI1M38HZH8-xY3nfoKmqoitmggq3C8zKE",
      authDomain: "buildinggroup-4f8b9.firebaseapp.com",
      projectId: "buildinggroup-4f8b9",
      storageBucket: "buildinggroup-4f8b9.firebasestorage.app",
      messagingSenderId: "353000992011",
      appId: "1:353000992011:web:c834310d7d79dd1bf0c60e",
      measurementId: "G-DF11Q5PZRT"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State
    let currentUser = null;
    let invoiceId = null;
    let invoice = null;

    // Elements
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('content');
    const okAlert = document.getElementById('okAlert');
    const errAlert = document.getElementById('errAlert');
    const infoAlert = document.getElementById('infoAlert');

    const headerSmall = document.getElementById('headerSmall');
    const invTitle = document.getElementById('invTitle');
    const invSub = document.getElementById('invSub');
    const statusBadge = document.getElementById('statusBadge');
    const amountMeta = document.getElementById('amountMeta');
    const balanceMeta = document.getElementById('balanceMeta');
    const createdMeta = document.getElementById('createdMeta');
    const dueMeta = document.getElementById('dueMeta');

    const invNumber = document.getElementById('invNumber');
    const invStatus = document.getElementById('invStatus');
    const jobInfo = document.getElementById('jobInfo');
    const reference = document.getElementById('reference');

    const custName = document.getElementById('custName');
    const custEmail = document.getElementById('custEmail');
    const custPhone = document.getElementById('custPhone');
    const custAddress = document.getElementById('custAddress');

    const itemsEmpty = document.getElementById('itemsEmpty');
    const itemsTable = document.getElementById('itemsTable');
    const itemsBody = document.getElementById('itemsBody');

    const subtotalVal = document.getElementById('subtotalVal');
    const taxVal = document.getElementById('taxVal');
    const totalVal = document.getElementById('totalVal');
    const paidVal = document.getElementById('paidVal');
    const balanceVal = document.getElementById('balanceVal');

    const paymentsEmpty = document.getElementById('paymentsEmpty');
    const paymentsList = document.getElementById('paymentsList');

    const notesBox = document.getElementById('notesBox');

    // Buttons
    const themeToggle = document.getElementById('themeToggle');
    const userAvatar = document.getElementById('userAvatar');
    const editBtn = document.getElementById('editBtn');
    const markPaidBtn = document.getElementById('markPaidBtn');
    const markSentBtn = document.getElementById('markSentBtn');
    const newPaymentBtn = document.getElementById('newPaymentBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    // Theme
    const htmlEl = document.documentElement;
    let currentTheme = localStorage.getItem('theme') || 'auto';
    htmlEl.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    themeToggle.addEventListener('click', ()=>{
      currentTheme = currentTheme==='auto'?'light':currentTheme==='light'?'dark':'auto';
      htmlEl.setAttribute('data-theme', currentTheme);
      localStorage.setItem('theme', currentTheme);
      updateThemeIcon();
    });
    function updateThemeIcon(){
      const i = themeToggle.querySelector('i');
      i.className = currentTheme==='light'?'fas fa-sun':currentTheme==='dark'?'fas fa-moon':'fas fa-adjust';
    }

    // Utils
    function showAlert(el, msg){ el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 6000); }
    function money(n, opts){ const v = parseFloat(n||0)||0; const o = opts||{ minimumFractionDigits:2, maximumFractionDigits:2 }; return 'Â£'+v.toLocaleString(undefined,o); }
    function asDate(v){
      if(!v) return null;
      if(typeof v.toDate==='function') return v.toDate();
      if(v instanceof Date) return v;
      if(typeof v==='number') return new Date(v);
      if(typeof v==='string'){ const d=new Date(v); return isNaN(d)?null:d }
      return null;
    }
    function getParamOrStorage(){
      const p = new URLSearchParams(location.search).get('id');
      return p || localStorage.getItem('selectedInvoiceId') || '';
    }
    function setStatusBadge(s){
      const st = (s||'pending').toLowerCase();
      statusBadge.textContent = st;
      statusBadge.className = 'badge '+st;
      invStatus.textContent = st;
    }
    function resolvedStatus(inv){
      let s = (inv.status||'pending').toLowerCase();
      const due = asDate(inv.dueDate);
      const paid = parseFloat(inv.paidAmount||0)||0;
      const total = parseFloat(inv.total ?? inv.amount ?? 0)||0;
      if((s==='pending' || s==='sent' || s==='approved') && due && due < new Date() && paid < total){
        s = 'overdue';
      }
      if(s==='paid' && paid < total){ s = 'pending'; }
      return s;
    }

    // Auth
    async function checkAuth(){
      return new Promise(resolve=>{
        const un = auth.onAuthStateChanged(async u=>{
          un();
          if(u && u.emailVerified){
            currentUser = u;
            try{
              const doc = await db.collection('users').doc(u.uid).get();
              const name = doc.exists ? (doc.data().firstName || 'U')+(doc.data().lastName?.[0]||'') : 'U';
              userAvatar.textContent = name.substring(0,2).toUpperCase();
            }catch{}
            resolve(true);
          } else {
            showAlert(errAlert,'Please login to view invoice');
            setTimeout(()=>location.href='/account/login.html',1500);
            resolve(false);
          }
        });
      });
    }

    // Load
    async function loadInvoice(){
      try{
        const ref = db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId);
        const snap = await ref.get();
        if(!snap.exists){
          showAlert(errAlert,'Invoice not found');
          setTimeout(()=>location.href='/account/invoices.html',1200);
          return false;
        }
        invoice = { id: snap.id, ...snap.data() };
        renderInvoice();
        return true;
      }catch(e){
        console.error(e);
        showAlert(errAlert,'Failed to load invoice');
        return false;
      }
    }

    // Render
    function renderInvoice(){
      // Header/title
      const number = invoice.number || `INV-${(invoice.id||'').slice(-6).toUpperCase()}`;
      const title = invoice.title || invoice.jobTitle || 'Invoice';
      const created = asDate(invoice.createdAt);
      const due = asDate(invoice.dueDate);
      const status = resolvedStatus(invoice);

      headerSmall.textContent = `Invoice ${number}`;
      invTitle.textContent = `${number} â€¢ ${title}`;
      invSub.textContent = `${number} â€¢ Created ${created?created.toLocaleString():'Unknown'}`;
      setStatusBadge(status);

      amountMeta.textContent = money(invoice.total ?? invoice.amount ?? 0, {minimumFractionDigits:0});
      const balance = computeBalance();
      balanceMeta.textContent = money(balance, {minimumFractionDigits:0});
      createdMeta.textContent = created ? created.toLocaleDateString() : '-';
      dueMeta.textContent = due ? due.toLocaleDateString() : 'Not set';

      // Invoice panel
      invNumber.textContent = number;
      jobInfo.textContent = invoice.jobTitle ? `${invoice.jobTitle}${invoice.jobId?` (${invoice.jobId})`:''}` : (invoice.jobId || 'â€”');
      reference.textContent = invoice.reference || invoice.poNumber || 'â€”';

      // Customer
      const c = invoice.customer || {};
      const full = c.fullName || [c.firstName,c.lastName].filter(Boolean).join(' ') || 'â€”';
      custName.textContent = full;
      custEmail.textContent = c.email || 'â€”';
      custPhone.textContent = c.phone || 'â€”';
      custAddress.textContent = c.address || 'â€”';

      // Items
      const items = Array.isArray(invoice.items) ? invoice.items : [];
      itemsBody.innerHTML = '';
      if(items.length){
        itemsEmpty.style.display = 'none';
        itemsTable.style.display = '';
        items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(it.item || it.name || '')}</td>
            <td>${escapeHtml(it.description || '')}</td>
            <td class="right">${Number(it.quantity||0)}</td>
            <td class="right">${Number(it.rate||0).toFixed(2)}</td>
            <td class="right">${Number(it.total ?? (Number(it.quantity||0)*Number(it.rate||0))).toFixed(2)}</td>
          `;
          itemsBody.appendChild(tr);
        });
      } else {
        itemsEmpty.style.display = '';
        itemsTable.style.display = 'none';
      }

      // Totals
      const totals = computeTotals();
      subtotalVal.textContent = money(totals.subtotal);
      taxVal.textContent = money(totals.tax);
      totalVal.textContent = money(totals.total);

      const paidAmt = parseFloat(invoice.paidAmount||0)||0;
      paidVal.textContent = money(paidAmt);
      balanceVal.textContent = money(totals.total - paidAmt);

      // Payments
      const pays = Array.isArray(invoice.payments) ? invoice.payments.slice().sort((a,b)=>{
        const at = asDate(a.date)?.getTime()||0, bt = asDate(b.date)?.getTime()||0; return bt-at;
      }) : [];
      paymentsList.innerHTML = '';
      if(!pays.length){
        paymentsEmpty.style.display = '';
      }else{
        paymentsEmpty.style.display = 'none';
        pays.forEach(p=>{
          const d = asDate(p.date);
          const div = document.createElement('div');
          div.className = 'payitem';
          div.innerHTML = `
            <div><strong>${escapeHtml(p.method||'Payment')}</strong>${p.note?` â€¢ ${escapeHtml(p.note)}`:''}</div>
            <div class="right"><strong>${money(p.amount||0)}</strong></div>
            <div>${d?d.toLocaleDateString():'â€”'}</div>
            <div class="muted">${escapeHtml(p.ref||'')}</div>
          `;
          paymentsList.appendChild(div);
        });
      }

      // Notes
      notesBox.textContent = (invoice.notes || invoice.internalNotes || invoice.publicNotes || '').trim() || 'None';

      // Show
      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';
    }

    function computeTotals(){
      const items = Array.isArray(invoice.items) ? invoice.items : [];
      if(items.length){
        const subtotal = +items.reduce((s,it)=> s + (parseFloat(it.total ?? (Number(it.quantity||0)*Number(it.rate||0)))||0), 0).toFixed(2);
        const taxRate = Number(invoice.taxRate ?? invoice.vatRate ?? 0);
        const tax = +(subtotal * (taxRate/100)).toFixed(2);
        return { subtotal, tax, total: +(subtotal + tax).toFixed(2) };
      }
      // fallback to fields
      const subtotal = parseFloat(invoice.subtotal ?? invoice.amount ?? 0) || 0;
      const tax = parseFloat(invoice.taxAmount ?? invoice.vatAmount ?? 0) || 0;
      const total = parseFloat(invoice.total ?? (subtotal + tax)) || 0;
      return { subtotal, tax, total };
    }
    function computeBalance(){
      const totals = computeTotals();
      const paidAmt = parseFloat(invoice.paidAmount||0)||0;
      return +(totals.total - paidAmt).toFixed(2);
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // Actions
    editBtn.addEventListener('click', ()=>{
      localStorage.setItem('editInvoiceId', invoiceId);
      location.href = `/account/add-invoice.html?edit=${encodeURIComponent(invoiceId)}`;
    });

    markPaidBtn.addEventListener('click', async ()=>{
      if(!confirm('Mark this invoice as fully paid?')) return;
      try{
        const totals = computeTotals();
        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).update({
          status:'paid',
          paidAmount: totals.total,
          paidAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showAlert(okAlert,'Invoice marked as paid');
        await loadInvoice();
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to mark as paid'); }
    });

    markSentBtn.addEventListener('click', async ()=>{
      try{
        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).update({
          status:'sent',
          sentAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showAlert(okAlert,'Invoice marked as sent');
        await loadInvoice();
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to update'); }
    });

    newPaymentBtn.addEventListener('click', async ()=>{
      try{
        const remaining = computeBalance();
        const amtStr = prompt(`Enter payment amount (remaining ${money(remaining)}):`, remaining > 0 ? remaining.toFixed(2) : '0.00');
        if(amtStr === null) return;
        const amount = parseFloat(amtStr||'0')||0;
        if(amount <= 0){ alert('Amount must be > 0'); return; }

        const method = prompt('Payment method (e.g. Card, Bank Transfer, Cash):','Bank Transfer') || 'Payment';
        const ref = prompt('Reference (optional):','') || '';
        const note = prompt('Note (optional):','') || '';

        // Build payment
        const payment = {
          amount,
          method,
          ref,
          note,
          date: new Date().toISOString()
        };

        const paidAmt = (parseFloat(invoice.paidAmount||0)||0) + amount;
        const totals = computeTotals();
        const newStatus = paidAmt >= (totals.total||0) ? 'paid' : (invoice.status||'pending');

        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).update({
          payments: firebase.firestore.FieldValue.arrayUnion(payment),
          paidAmount: +paidAmt.toFixed(2),
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showAlert(okAlert,'Payment recorded');
        await loadInvoice();
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to record payment'); }
    });

    downloadBtn.addEventListener('click', ()=>{
      const el = document.getElementById('content');
      if(!el || !window.html2pdf){ window.print(); return; }
      // Delay to ensure fonts/icons ready
      setTimeout(()=>{
        const number = invoice?.number || `INV-${(invoiceId||'').slice(-6).toUpperCase()}`;
        html2pdf().set({
          margin: 10,
          filename: `${number}.pdf`,
          image: {type:'jpeg', quality:0.95},
          html2canvas: {scale: 2, useCORS: true, backgroundColor:'#ffffff'},
          jsPDF: {unit:'mm', format:'a4', orientation:'portrait'},
          pagebreak: {mode:['css','legacy']}
        }).from(el).save();
      }, 60);
    });

    printBtn.addEventListener('click', ()=>window.print());

    deleteBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete this invoice? This cannot be undone.')) return;
      try{
        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).delete();
        showAlert(okAlert,'Invoice deleted');
        setTimeout(()=>location.href='/account/invoices.html', 700);
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to delete'); }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      invoiceId = getParamOrStorage();
      if(!invoiceId){
        showAlert(errAlert,'Missing invoice ID');
        setTimeout(()=>location.href='/account/invoices.html',1200);
        return;
      }
      const ok = await checkAuth();
      if(!ok) return;
      await loadInvoice();
    });
  </script>
</body>
</html>
