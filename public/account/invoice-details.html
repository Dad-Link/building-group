<!DOCTYPE html>
<html lang="en" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Invoice Details | Building Group</title>
  <meta name="description" content="View and manage a single invoice. Mark as paid, record payments, send, print, and download PDF.">
  <meta name="robots" content="noindex, nofollow">

  <!-- CSP -->
  <meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' 'unsafe-eval'
      https://www.gstatic.com
      https://www.googleapis.com
      https://apis.google.com
      https://cdn.jsdelivr.net;
    connect-src 'self'
      https://identitytoolkit.googleapis.com
      https://www.googleapis.com
      https://securetoken.googleapis.com
      https://buildinggroup-4f8b9-default-rtdb.firebaseio.com
      https://firestore.googleapis.com
      https://buildinggroup-4f8b9.firebasestorage.app
      https://www.gstatic.com
      https://*.gstatic.com;
    img-src 'self' data:
      https://www.gstatic.com
      https://fonts.gstatic.com;
    style-src 'self' 'unsafe-inline'
      https://fonts.googleapis.com
      https://cdnjs.cloudflare.com;
    font-src 'self'
      https://fonts.gstatic.com
      https://cdnjs.cloudflare.com;
    frame-src 'self' https://buildinggroup-4f8b9.firebaseapp.com;
  ">

  <!-- Fonts / Icons -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

  <!-- PDF generator -->
  <script src="https://cdn.jsdelivr.net/npm/html2pdf.js@0.10.1/dist/html2pdf.bundle.min.js" defer></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    :root{
      --primary-color:#e74c3c;--primary-dark:#c0392b;--secondary:#3498db;
      --success:#27ae60;--warning:#f39c12;--danger:#e74c3c;--info:#17a2b8;
      --text:#2c3e50;--muted:#6c757d;--bg:#f8fafc;--bg-2:#ecf0f1;--card:#fff;
      --border:#dee2e6;--border-light:#f1f3f4;--shadow:0 4px 12px rgba(0,0,0,.1);
      --shadow-lg:0 8px 32px rgba(0,0,0,.15)
    }
    [data-theme="dark"]{
      --text:#fff;--muted:#bdc3c7;--bg:#0f0f0f;--bg-2:#1a1a1a;--card:#1e1e1e;--border:#333;--border-light:#2a2a2a
    }
    @media (prefers-color-scheme: dark){
      :root[data-theme="auto"]{
        --text:#fff;--muted:#bdc3c7;--bg:#0f0f0f;--bg-2:#1a1a1a;--card:#1e1e1e;--border:#333;--border-light:#2a2a2a
      }
    }
    body{font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);line-height:1.6;min-height:100vh}
    .container{max-width:1100px;margin:0 auto;padding:1.75rem 1rem}
    .header{background:var(--card);box-shadow:var(--shadow);position:sticky;top:0;z-index:5}
    .header-inner{display:flex;align-items:center;justify-content:space-between;gap:1rem;padding:1rem 1.25rem}
    .back-btn{background:var(--bg-2);border:1px solid var(--border);color:var(--text);text-decoration:none;border-radius:8px;padding:.55rem .9rem;display:inline-flex;gap:.5rem;align-items:center;font-weight:700}
    .back-btn:hover{background:var(--primary-color);border-color:var(--primary-color);color:#fff;transform:translateY(-1px)}
    .h-title{font-size:1.4rem;font-weight:800}
    .right{display:flex;align-items:center;gap:.6rem}
    .theme-toggle{background:var(--bg-2);border:1px solid var(--border);color:var(--text);width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center}
    .avatar{width:34px;height:34px;border-radius:50%;background:linear-gradient(135deg,#e74c3c,#c0392b);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:800}

    .toolbar{display:flex;flex-wrap:wrap;gap:.5rem;margin-top:.75rem}
    .btn{border:none;border-radius:8px;padding:.6rem .9rem;font-weight:800;display:inline-flex;align-items:center;gap:.45rem;cursor:pointer}
    .btn-primary{background:var(--primary-color);color:#fff}
    .btn-secondary{background:var(--bg-2);color:var(--text);border:1px solid var(--border)}
    .btn-success{background:linear-gradient(135deg,#27ae60,#229954);color:#fff}
    .btn-info{background:linear-gradient(135deg,#3498db,#2980b9);color:#fff}
    .btn-warning{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff}
    .btn-danger{background:var(--danger);color:#fff}
    .btn:disabled{opacity:.6;cursor:not-allowed}

    .alert{display:none;margin:1rem 0;padding:1rem;border-radius:10px;font-weight:700}
    .alert.show{display:block}
    .alert-success{background:rgba(39,174,96,.12);color:var(--success);border:1px solid rgba(39,174,96,.25)}
    .alert-error{background:rgba(231,76,60,.12);color:var(--danger);border:1px solid rgba(231,76,60,.25)}
    .alert-info{background:rgba(52,152,219,.12);color:#2980b9;border:1px solid rgba(52,152,219,.25)}

    .loading{display:flex;justify-content:center;align-items:center;min-height:40vh}
    .spinner{width:44px;height:44px;border:3px solid var(--border);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .card{background:var(--card);border-radius:16px;box-shadow:var(--shadow);padding:1.25rem;margin:1rem 0}
    .title-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:flex-start;justify-content:space-between}
    .invoice-title{font-size:1.8rem;font-weight:900}
    .subtle{color:var(--muted);font-weight:600}
    .badge{display:inline-block;padding:.35rem .7rem;border-radius:999px;font-weight:900;font-size:.8rem;letter-spacing:.4px;text-transform:uppercase}
    .badge.draft{background:rgba(243,156,18,.12);color:var(--warning)}
    .badge.pending{background:rgba(52,152,219,.12);color:#2980b9}
    .badge.sent{background:rgba(52,152,219,.12);color:#2980b9}
    .badge.paid{background:rgba(39,174,96,.12);color:var(--success)}
    .badge.overdue{background:rgba(231,76,60,.12);color:var(--danger)}
    .badge.cancelled{background:rgba(149,165,166,.12);color:#95a5a6}

    .meta-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.8rem;margin-top:1rem}
    .meta-box{background:var(--bg-2);border-radius:12px;padding:.9rem;text-align:center}
    .meta-val{font-size:1.15rem;font-weight:900;color:var(--primary-color)}
    .meta-lbl{font-size:.85rem;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;margin-top:.2rem}

    .two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
    @media(max-width:900px){.two-col{grid-template-columns:1fr}}
    .kv{display:grid;grid-template-columns:140px 1fr;gap:.5rem;background:var(--bg-2);border-radius:10px;padding:.6rem .75rem;margin:.4rem 0}
    .kv .k{font-weight:900;color:var(--muted)}
    .kv .v{font-weight:700}

    table{width:100%;border-collapse:collapse}
    th,td{padding:.7rem;border-bottom:1px solid var(--border-light);text-align:left}
    th{background:var(--bg-2);font-size:.85rem;text-transform:uppercase;letter-spacing:.4px}
    .right{text-align:right}
    .totals{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:.6rem;margin-top:1rem}
    .tbox{background:var(--bg-2);border-radius:10px;padding:.8rem;text-align:center}
    .t-lbl{font-size:.8rem;color:var(--muted);text-transform:uppercase}
    .t-val{font-size:1.15rem;font-weight:900;color:var(--primary-color)}

    .paylist{margin-top:.5rem}
    .payitem{display:grid;grid-template-columns:1fr 120px 160px 1fr;gap:.6rem;background:var(--bg-2);border-radius:10px;padding:.6rem .75rem;margin:.4rem 0}
    @media(max-width:720px){.payitem{grid-template-columns:1fr 1fr}}
    .muted{color:var(--muted)}

    @media print{
      .header,.toolbar,.alert{display:none !important}
      body{background:#fff}
      .card{box-shadow:none;border:1px solid #eee;border-radius:0}
      .container{max-width:100%;padding:0}
    }
    *:focus-visible{outline:2px solid var(--primary-color);outline-offset:2px}

    /* ---------- PDF TEMPLATE (professional layout) ---------- */
    .pdf-root{
      width:210mm; min-height:297mm; background:#ffffff; color:#222; font-size:12px;
      display:block; margin:0 auto; position:relative;
    }
    .pdf-inner{padding:16mm 14mm 16mm 14mm;}
    .pdf-header{
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px; position:relative;
      border-bottom:3px solid #f0f2f5; padding-bottom:12px; margin-bottom:12px;
    }
    .brand{
      display:flex; flex-direction:column; gap:6px;
    }
    .brand .company-name{font-size:18px; font-weight:900; color:#111;}
    .brand .company-meta{color:#6c757d; line-height:1.5;}
    .brand .accent{display:inline-block; height:4px; width:72px; background:linear-gradient(90deg,#e74c3c,#c0392b); border-radius:2px;}
    .logo-wrap{min-width:120px; text-align:right;}
    .logo-wrap img{max-width:120px; height:auto; object-fit:contain; image-rendering:auto;}
    .pdf-title-row{display:flex; justify-content:space-between; align-items:flex-end; margin-top:8px;}
    .pdf-title{font-size:26px; font-weight:900; letter-spacing:.4px;}
    .pdf-number{color:#6c757d; font-weight:700;}
    .info-grid{display:grid; grid-template-columns:1fr 1fr; gap:10mm; margin-top:10mm;}
    .box{border:1px solid #e9ecef; border-radius:8px; padding:10px;}
    .box h4{font-size:12px; text-transform:uppercase; letter-spacing:.4px; color:#6c757d; margin-bottom:6px;}
    .box .kv{display:grid; grid-template-columns:28mm 1fr; gap:4px; padding:0; background:transparent; border-radius:0; margin:2px 0;}
    .box .kv .k{font-weight:800; color:#6c757d;}
    .box .kv .v{font-weight:700; color:#222;}
    .items-table{width:100%; border-collapse:separate; border-spacing:0; margin-top:12px;}
    .items-table thead th{
      background:#f5f7fa; color:#222; border-top:1px solid #e9ecef; border-bottom:1px solid #e9ecef;
    }
    .items-table th,.items-table td{padding:9px 8px; font-size:12px;}
    .items-table tbody tr td{border-bottom:1px solid #f1f3f5;}
    .items-table .num{text-align:right; white-space:nowrap;}
    .totals-grid{display:grid; grid-template-columns:1fr 70mm; gap:10mm; margin-top:8mm;}
    .totals-card{border:1px solid #e9ecef; border-radius:8px; padding:10px;}
    .total-row{display:grid; grid-template-columns:1fr auto; gap:8px; padding:6px 0; border-bottom:1px dashed #e9ecef;}
    .total-row:last-child{border-bottom:none;}
    .total-row .lbl{color:#6c757d; font-weight:800; text-transform:uppercase; font-size:11px;}
    .total-row .val{font-weight:900;}
    .grand{background:#fafbfc; border:1px solid #e9ecef; border-radius:8px; padding:10px; margin-top:8px;}
    .grand .lbl{font-size:12px; color:#111;}
    .grand .val{font-size:16px; color:#e74c3c;}
    .notes-payments{display:grid; grid-template-columns:1fr 1fr; gap:10mm; margin-top:10mm;}
    .note-box{border:1px dashed #e9ecef; border-radius:8px; padding:10px; min-height:38mm;}
    .muted-small{font-size:11px; color:#6c757d;}
    .pdf-footer{
      position:absolute; left:14mm; right:14mm; bottom:10mm; display:flex; justify-content:space-between; align-items:center; color:#6c757d; font-size:10px;
      border-top:1px solid #f0f2f5; padding-top:6px;
    }
    .pdf-footer .brandline{font-weight:800; color:#c0392b;}
    .pdf-footer .page{font-weight:700;}
    /* Hide PDF template in app view */
    #invoicePdf{position:absolute; left:-99999px; top:0; visibility:hidden;}
  </style>
</head>
<body>
  <!-- Header -->
  <div class="header">
    <div class="header-inner">
      <div style="display:flex;align-items:center;gap:.75rem">
        <a href="/account/invoices.html" class="back-btn"><i class="fas fa-arrow-left"></i> Back to Invoices</a>
        <div class="h-title subtle" id="headerSmall">Invoice</div>
      </div>
      <div class="right">
        <button class="theme-toggle" id="themeToggle" title="Toggle theme"><i class="fas fa-moon"></i></button>
        <div class="avatar" id="userAvatar">--</div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Alerts -->
    <div class="alert alert-success" id="okAlert"></div>
    <div class="alert alert-error" id="errAlert"></div>
    <div class="alert alert-info" id="infoAlert"></div>

    <!-- Loading -->
    <div id="loading" class="loading"><div class="spinner"></div></div>

    <!-- Content -->
    <div id="content" style="display:none">
      <!-- Title + actions -->
      <div class="card" id="printHeader">
        <div class="title-row">
          <div>
            <div class="invoice-title" id="invTitle">Invoice</div>
            <div class="subtle" id="invSub">INV-0000 • Created -</div>
          </div>
          <div>
            <span class="badge" id="statusBadge">pending</span>
          </div>
        </div>

        <div class="toolbar" style="margin-top:.9rem">
          <button class="btn btn-primary" id="editBtn"><i class="fas fa-edit"></i> Edit</button>
          <button class="btn btn-success" id="markPaidBtn"><i class="fas fa-check-circle"></i> Mark as Paid</button>
          <button class="btn btn-info" id="markSentBtn"><i class="fas fa-paper-plane"></i> Mark as Sent</button>
          <button class="btn btn-secondary" id="newPaymentBtn"><i class="fas fa-coins"></i> Record Payment</button>
          <button class="btn btn-secondary" id="downloadBtn"><i class="fas fa-file-pdf"></i> Download PDF</button>
          <button class="btn btn-secondary" id="printBtn"><i class="fas fa-print"></i> Print</button>
          <button class="btn btn-danger" id="deleteBtn"><i class="fas fa-trash"></i> Delete</button>
        </div>

        <div class="meta-grid">
          <div class="meta-box">
            <div class="meta-val" id="amountMeta">£0</div>
            <div class="meta-lbl">Invoice Total</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="balanceMeta">£0</div>
            <div class="meta-lbl">Balance Due</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="createdMeta">-</div>
            <div class="meta-lbl">Created</div>
          </div>
          <div class="meta-box">
            <div class="meta-val" id="dueMeta">Not set</div>
            <div class="meta-lbl">Due Date</div>
          </div>
        </div>
      </div>

      <!-- Parties -->
      <div class="two-col">
        <div class="card">
          <div style="font-weight:900;margin-bottom:.5rem"><i class="fas fa-file-invoice"></i> Invoice</div>
          <div class="kv"><div class="k">Number</div><div class="v" id="invNumber">-</div></div>
          <div class="kv"><div class="k">Status</div><div class="v" id="invStatus">-</div></div>
          <div class="kv"><div class="k">Job</div><div class="v" id="jobInfo">-</div></div>
          <div class="kv"><div class="k">Reference</div><div class="v" id="reference">-</div></div>
        </div>
        <div class="card">
          <div style="font-weight:900;margin-bottom:.5rem"><i class="fas fa-user"></i> Billed To</div>
          <div class="kv"><div class="k">Name</div><div class="v" id="custName">-</div></div>
          <div class="kv"><div class="k">Email</div><div class="v" id="custEmail">-</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v" id="custPhone">-</div></div>
          <div class="kv"><div class="k">Address</div><div class="v" id="custAddress">-</div></div>
        </div>
      </div>

      <!-- Items -->
      <div class="card">
        <div style="font-weight:900;margin-bottom:.6rem"><i class="fas fa-list-ul"></i> Items</div>
        <div id="itemsEmpty" class="muted" style="margin-bottom:.6rem">No line items. Using invoice amount.</div>
        <div class="table-wrap">
          <table id="itemsTable" style="display:none">
            <thead>
              <tr>
                <th style="min-width:220px">Item</th>
                <th style="min-width:260px">Description</th>
                <th class="right" style="width:110px">Qty</th>
                <th class="right" style="width:140px">Rate (£)</th>
                <th class="right" style="width:140px">Total (£)</th>
              </tr>
            </thead>
            <tbody id="itemsBody"></tbody>
          </table>
        </div>
        <div class="totals">
          <div class="tbox">
            <div class="t-lbl">Subtotal</div>
            <div class="t-val" id="subtotalVal">£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Tax</div>
            <div class="t-val" id="taxVal">£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Total</div>
            <div class="t-val" id="totalVal">£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Paid</div>
            <div class="t-val" id="paidVal">£0</div>
          </div>
          <div class="tbox">
            <div class="t-lbl">Balance</div>
            <div class="t-val" id="balanceVal">£0</div>
          </div>
        </div>
      </div>

      <!-- Payments -->
      <div class="card">
        <div style="font-weight:900;margin-bottom:.6rem"><i class="fas fa-coins"></i> Payments</div>
        <div id="paymentsEmpty" class="muted">No payments recorded.</div>
        <div class="paylist" id="paymentsList"></div>
      </div>

      <!-- Notes -->
      <div class="card">
        <div style="font-weight:900;margin-bottom:.6rem"><i class="fas fa-sticky-note"></i> Notes</div>
        <div id="notesBox" class="muted">None</div>
      </div>
    </div>
  </div>

  <!-- PRO PDF TEMPLATE (hidden in UI, used for PDF export) -->
  <div id="invoicePdf" class="pdf-root" aria-hidden="true">
    <div class="pdf-inner">
      <div class="pdf-header">
        <div class="brand">
          <div class="company-name" id="pdfCompanyName">Building Group</div>
          <div class="company-meta" id="pdfCompanyMeta">
            <div id="pdfCompanyAddress">Address</div>
            <div><span id="pdfCompanyPhone">Phone</span> • <span id="pdfCompanyEmail">Email</span></div>
            <div><span id="pdfCompanyWebsite">Website</span></div>
            <div><span id="pdfCompanyReg"></span> <span id="pdfCompanyVat"></span></div>
          </div>
          <span class="accent"></span>
        </div>
        <div class="logo-wrap">
          <img id="pdfLogo" src="/logo.png" alt="Company Logo" onerror="this.src='/assets/logo-180.png'; this.style.maxWidth='110px';">
        </div>
      </div>

      <div class="pdf-title-row">
        <div class="pdf-title">INVOICE</div>
        <div class="pdf-number" id="pdfNumber">INV-0000</div>
      </div>

      <div class="info-grid">
        <div class="box">
          <h4>Billed To</h4>
          <div class="kv"><div class="k">Name</div><div class="v" id="pdfBillName">-</div></div>
          <div class="kv"><div class="k">Email</div><div class="v" id="pdfBillEmail">-</div></div>
          <div class="kv"><div class="k">Phone</div><div class="v" id="pdfBillPhone">-</div></div>
          <div class="kv"><div class="k">Address</div><div class="v" id="pdfBillAddress">-</div></div>
        </div>
        <div class="box">
          <h4>Invoice Details</h4>
          <div class="kv"><div class="k">Number</div><div class="v" id="pdfInvNumber">-</div></div>
          <div class="kv"><div class="k">Date</div><div class="v" id="pdfInvDate">-</div></div>
          <div class="kv"><div class="k">Due</div><div class="v" id="pdfInvDue">-</div></div>
          <div class="kv"><div class="k">Status</div><div class="v" id="pdfInvStatus">-</div></div>
          <div class="kv"><div class="k">Job</div><div class="v" id="pdfInvJob">-</div></div>
        </div>
      </div>

      <table class="items-table" id="pdfItemsTable">
        <thead>
          <tr>
            <th>Description</th>
            <th class="num">Qty</th>
            <th class="num">Rate (£)</th>
            <th class="num">Line Total (£)</th>
          </tr>
        </thead>
        <tbody id="pdfItemsBody"></tbody>
      </table>

      <div class="totals-grid">
        <div>
          <div class="note-box">
            <h4 style="margin:0 0 6px 0; color:#111;">Notes</h4>
            <div id="pdfNotes" class="muted-small">—</div>
          </div>
          <div class="note-box" style="margin-top:8px;">
            <h4 style="margin:0 0 6px 0; color:#111;">Payment Instructions</h4>
            <div id="pdfPayInstructions" class="muted-small">
              Please make payment via bank transfer. Include invoice number as reference.
            </div>
          </div>
        </div>
        <div>
          <div class="totals-card">
            <div class="total-row"><div class="lbl">Subtotal</div><div class="val" id="pdfSubtotal">£0.00</div></div>
            <div class="total-row"><div class="lbl">Tax</div><div class="val" id="pdfTax">£0.00</div></div>
            <div class="total-row"><div class="lbl">Paid</div><div class="val" id="pdfPaid">£0.00</div></div>
            <div class="total-row"><div class="lbl">Balance</div><div class="val" id="pdfBalance">£0.00</div></div>
          </div>
          <div class="grand">
            <div class="total-row" style="border:none;">
              <div class="lbl">Total (GBP)</div>
              <div class="val" id="pdfTotal">£0.00</div>
            </div>
          </div>
        </div>
      </div>

      <div class="pdf-footer">
        <div class="brandline">Building Group • Professional Construction Services</div>
        <div class="page" id="pdfPageNum">Page 1 of 1</div>
      </div>
    </div>
  </div>

  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyBI1M38HZH8-xY3nfoKmqoitmggq3C8zKE",
      authDomain: "buildinggroup-4f8b9.firebaseapp.com",
      projectId: "buildinggroup-4f8b9",
      storageBucket: "buildinggroup-4f8b9.firebasestorage.app",
      messagingSenderId: "353000992011",
      appId: "1:353000992011:web:c834310d7d79dd1bf0c60e",
      measurementId: "G-DF11Q5PZRT"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();

    // State
    let currentUser = null;
    let invoiceId = null;
    let invoice = null;
    let company = null;

    // Elements
    const loadingEl = document.getElementById('loading');
    const contentEl = document.getElementById('content');
    const okAlert = document.getElementById('okAlert');
    const errAlert = document.getElementById('errAlert');
    const infoAlert = document.getElementById('infoAlert');

    const headerSmall = document.getElementById('headerSmall');
    const invTitle = document.getElementById('invTitle');
    const invSub = document.getElementById('invSub');
    const statusBadge = document.getElementById('statusBadge');
    const amountMeta = document.getElementById('amountMeta');
    const balanceMeta = document.getElementById('balanceMeta');
    const createdMeta = document.getElementById('createdMeta');
    const dueMeta = document.getElementById('dueMeta');

    const invNumber = document.getElementById('invNumber');
    const invStatus = document.getElementById('invStatus');
    const jobInfo = document.getElementById('jobInfo');
    const reference = document.getElementById('reference');

    const custName = document.getElementById('custName');
    const custEmail = document.getElementById('custEmail');
    const custPhone = document.getElementById('custPhone');
    const custAddress = document.getElementById('custAddress');

    const itemsEmpty = document.getElementById('itemsEmpty');
    const itemsTable = document.getElementById('itemsTable');
    const itemsBody = document.getElementById('itemsBody');

    const subtotalVal = document.getElementById('subtotalVal');
    const taxVal = document.getElementById('taxVal');
    const totalVal = document.getElementById('totalVal');
    const paidVal = document.getElementById('paidVal');
    const balanceVal = document.getElementById('balanceVal');

    const paymentsEmpty = document.getElementById('paymentsEmpty');
    const paymentsList = document.getElementById('paymentsList');

    const notesBox = document.getElementById('notesBox');

    // Buttons
    const themeToggle = document.getElementById('themeToggle');
    const userAvatar = document.getElementById('userAvatar');
    const editBtn = document.getElementById('editBtn');
    const markPaidBtn = document.getElementById('markPaidBtn');
    const markSentBtn = document.getElementById('markSentBtn');
    const newPaymentBtn = document.getElementById('newPaymentBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const printBtn = document.getElementById('printBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    // Theme
    const htmlEl = document.documentElement;
    let currentTheme = localStorage.getItem('theme') || 'auto';
    htmlEl.setAttribute('data-theme', currentTheme);
    updateThemeIcon();
    themeToggle.addEventListener('click', ()=>{
      currentTheme = currentTheme==='auto'?'light':currentTheme==='light'?'dark':'auto';
      htmlEl.setAttribute('data-theme', currentTheme);
      localStorage.setItem('theme', currentTheme);
      updateThemeIcon();
    });
    function updateThemeIcon(){
      const i = themeToggle.querySelector('i');
      i.className = currentTheme==='light'?'fas fa-sun':currentTheme==='dark'?'fas fa-moon':'fas fa-adjust';
    }

    // Utils
    function showAlert(el, msg){ el.textContent = msg; el.classList.add('show'); setTimeout(()=>el.classList.remove('show'), 6000); }
    function money(n, opts){ const v = parseFloat(n||0)||0; const o = opts||{ minimumFractionDigits:2, maximumFractionDigits:2 }; return '£'+v.toLocaleString(undefined,o); }
    function asDate(v){
      if(!v) return null;
      if(typeof v.toDate==='function') return v.toDate();
      if(v instanceof Date) return v;
      if(typeof v==='number') return new Date(v);
      if(typeof v==='string'){ const d=new Date(v); return isNaN(d)?null:d }
      return null;
    }
    function getParamOrStorage(){
      const p = new URLSearchParams(location.search).get('id');
      return p || localStorage.getItem('selectedInvoiceId') || '';
    }
    function setStatusBadge(s){
      const st = (s||'pending').toLowerCase();
      statusBadge.textContent = st;
      statusBadge.className = 'badge '+st;
      invStatus.textContent = st;
    }
    function resolvedStatus(inv){
      let s = (inv.status||'pending').toLowerCase();
      const due = asDate(inv.dueDate);
      const paid = parseFloat(inv.paidAmount||0)||0;
      const total = parseFloat(inv.total ?? inv.amount ?? 0)||0;
      if((s==='pending' || s==='sent' || s==='approved') && due && due < new Date() && paid < total){
        s = 'overdue';
      }
      if(s==='paid' && paid < total){ s = 'pending'; }
      return s;
    }

    // Auth
    async function checkAuth(){
      return new Promise(resolve=>{
        const un = auth.onAuthStateChanged(async u=>{
          un();
          if(u && u.emailVerified){
            currentUser = u;
            try{
              const doc = await db.collection('users').doc(u.uid).get();
              company = buildCompanyFromDoc(doc);
              const name = doc.exists ? (doc.data().firstName || 'U')+(doc.data().lastName?.[0]||'') : 'U';
              userAvatar.textContent = name.substring(0,2).toUpperCase();
            }catch{}
            resolve(true);
          } else {
            showAlert(errAlert,'Please login to view invoice');
            setTimeout(()=>location.href='/account/login.html',1500);
            resolve(false);
          }
        });
      });
    }

    function buildCompanyFromDoc(doc){
      const d = doc.exists ? (doc.data()||{}) : {};
      return {
        name: d.companyName || 'Building Group',
        address: d.companyAddress || 'Manchester, Liverpool, Leeds & Cheshire',
        phone: d.phone || d.companyPhone || '+44 161 524 0819',
        email: d.email || d.companyEmail || 'info@building-group.co.uk',
        website: d.companyWebsite || 'www.building-group.co.uk',
        vat: d.vatNumber ? `VAT: ${d.vatNumber}` : '',
        reg: d.companyReg ? `Reg: ${d.companyReg}` : '',
        payInstructions: d.paymentInstructions || 'Please pay by bank transfer and include the invoice number as reference.'
      };
    }

    // Load
    async function loadInvoice(){
      try{
        const ref = db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId);
        const snap = await ref.get();
        if(!snap.exists){
          showAlert(errAlert,'Invoice not found');
          setTimeout(()=>location.href='/account/invoices.html',1200);
          return false;
        }
        invoice = { id: snap.id, ...snap.data() };
        renderInvoice();
        return true;
      }catch(e){
        console.error(e);
        showAlert(errAlert,'Failed to load invoice');
        return false;
      }
    }

    // Render (screen view)
    function renderInvoice(){
      const number = invoice.number || `INV-${(invoice.id||'').slice(-6).toUpperCase()}`;
      const title = invoice.title || invoice.jobTitle || 'Invoice';
      const created = asDate(invoice.createdAt);
      const due = asDate(invoice.dueDate);
      const status = resolvedStatus(invoice);

      headerSmall.textContent = `Invoice ${number}`;
      invTitle.textContent = `${number} • ${title}`;
      invSub.textContent = `${number} • Created ${created?created.toLocaleString():'Unknown'}`;
      setStatusBadge(status);

      amountMeta.textContent = money(invoice.total ?? invoice.amount ?? 0, {minimumFractionDigits:0});
      const balance = computeBalance();
      balanceMeta.textContent = money(balance, {minimumFractionDigits:0});
      createdMeta.textContent = created ? created.toLocaleDateString() : '-';
      dueMeta.textContent = due ? due.toLocaleDateString() : 'Not set';

      invNumber.textContent = number;
      jobInfo.textContent = invoice.jobTitle ? `${invoice.jobTitle}${invoice.jobId?` (${invoice.jobId})`:''}` : (invoice.jobId || '—');
      reference.textContent = invoice.reference || invoice.poNumber || '—';

      const c = invoice.customer || {};
      const full = c.fullName || [c.firstName,c.lastName].filter(Boolean).join(' ') || '—';
      custName.textContent = full;
      custEmail.textContent = c.email || '—';
      custPhone.textContent = c.phone || '—';
      custAddress.textContent = c.address || '—';

      const items = Array.isArray(invoice.items) ? invoice.items : [];
      itemsBody.innerHTML = '';
      if(items.length){
        itemsEmpty.style.display = 'none';
        itemsTable.style.display = '';
        items.forEach(it=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(it.item || it.name || '')}</td>
            <td>${escapeHtml(it.description || '')}</td>
            <td class="right">${Number(it.quantity||0)}</td>
            <td class="right">${Number(it.rate||0).toFixed(2)}</td>
            <td class="right">${Number(it.total ?? (Number(it.quantity||0)*Number(it.rate||0))).toFixed(2)}</td>
          `;
          itemsBody.appendChild(tr);
        });
      } else {
        itemsEmpty.style.display = '';
        itemsTable.style.display = 'none';
      }

      const totals = computeTotals();
      subtotalVal.textContent = money(totals.subtotal);
      taxVal.textContent = money(totals.tax);
      totalVal.textContent = money(totals.total);

      const paidAmt = parseFloat(invoice.paidAmount||0)||0;
      paidVal.textContent = money(paidAmt);
      balanceVal.textContent = money(totals.total - paidAmt);

      const pays = Array.isArray(invoice.payments) ? invoice.payments.slice().sort((a,b)=>{
        const at = asDate(a.date)?.getTime()||0, bt = asDate(b.date)?.getTime()||0; return bt-at;
      }) : [];
      paymentsList.innerHTML = '';
      if(!pays.length){
        paymentsEmpty.style.display = '';
      }else{
        paymentsEmpty.style.display = 'none';
        pays.forEach(p=>{
          const d = asDate(p.date);
          const div = document.createElement('div');
          div.className = 'payitem';
          div.innerHTML = `
            <div><strong>${escapeHtml(p.method||'Payment')}</strong>${p.note?` • ${escapeHtml(p.note)}`:''}</div>
            <div class="right"><strong>${money(p.amount||0)}</strong></div>
            <div>${d?d.toLocaleDateString():'—'}</div>
            <div class="muted">${escapeHtml(p.ref||'')}</div>
          `;
          paymentsList.appendChild(div);
        });
      }

      notesBox.textContent = (invoice.notes || invoice.internalNotes || invoice.publicNotes || '').trim() || 'None';

      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';
    }

    function computeTotals(){
      const items = Array.isArray(invoice.items) ? invoice.items : [];
      if(items.length){
        const subtotal = +items.reduce((s,it)=> s + (parseFloat(it.total ?? (Number(it.quantity||0)*Number(it.rate||0)))||0), 0).toFixed(2);
        const taxRate = Number(invoice.taxRate ?? invoice.vatRate ?? 0);
        const tax = +(subtotal * (taxRate/100)).toFixed(2);
        return { subtotal, tax, total: +(subtotal + tax).toFixed(2) };
      }
      const subtotal = parseFloat(invoice.subtotal ?? invoice.amount ?? 0) || 0;
      const tax = parseFloat(invoice.taxAmount ?? invoice.vatAmount ?? 0) || 0;
      const total = parseFloat(invoice.total ?? (subtotal + tax)) || 0;
      return { subtotal, tax, total };
    }
    function computeBalance(){
      const totals = computeTotals();
      const paidAmt = parseFloat(invoice.paidAmount||0)||0;
      return +(totals.total - paidAmt).toFixed(2);
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])) }

    // Actions
    editBtn.addEventListener('click', ()=>{
      localStorage.setItem('editInvoiceId', invoiceId);
      location.href = `/account/add-invoice.html?edit=${encodeURIComponent(invoiceId)}`;
    });

    markPaidBtn.addEventListener('click', async ()=>{
      if(!confirm('Mark this invoice as fully paid?')) return;
      try{
        const totals = computeTotals();
        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).update({
          status:'paid',
          paidAmount: totals.total,
          paidAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showAlert(okAlert,'Invoice marked as paid');
        await loadInvoice();
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to mark as paid'); }
    });

    markSentBtn.addEventListener('click', async ()=>{
      try{
        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).update({
          status:'sent',
          sentAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showAlert(okAlert,'Invoice marked as sent');
        await loadInvoice();
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to update'); }
    });

    newPaymentBtn.addEventListener('click', async ()=>{
      try{
        const remaining = computeBalance();
        const amtStr = prompt(`Enter payment amount (remaining ${money(remaining)}):`, remaining > 0 ? remaining.toFixed(2) : '0.00');
        if(amtStr === null) return;
        const amount = parseFloat(amtStr||'0')||0;
        if(amount <= 0){ alert('Amount must be > 0'); return; }

        const method = prompt('Payment method (e.g. Card, Bank Transfer, Cash):','Bank Transfer') || 'Payment';
        const ref = prompt('Reference (optional):','') || '';
        const note = prompt('Note (optional):','') || '';

        const payment = {
          amount,
          method,
          ref,
          note,
          date: new Date().toISOString()
        };

        const paidAmt = (parseFloat(invoice.paidAmount||0)||0) + amount;
        const totals = computeTotals();
        const newStatus = paidAmt >= (totals.total||0) ? 'paid' : (invoice.status||'pending');

        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).update({
          payments: firebase.firestore.FieldValue.arrayUnion(payment),
          paidAmount: +paidAmt.toFixed(2),
          status: newStatus,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showAlert(okAlert,'Payment recorded');
        await loadInvoice();
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to record payment'); }
    });

    // PRO PDF: build content in hidden template and export
    downloadBtn.addEventListener('click', async ()=>{
      if(!window.html2pdf){ window.print(); return; }
      try{
        buildPdfFromData(invoice, company);
        // Give the browser a tick to paint images (logo)
        await new Promise(res=>setTimeout(res, 80));
        const number = invoice?.number || `INV-${(invoiceId||'').slice(-6).toUpperCase()}`;
        const element = document.getElementById('invoicePdf');

        // html2pdf pipeline with page numbers via jsPDF after render
        const opt = {
          margin: [10, 8, 14, 8], // top, left, bottom, right (mm)
          filename: `${number}.pdf`,
          image: { type:'jpeg', quality:0.98 },
          html2canvas: { scale: 2, useCORS: true, backgroundColor:'#ffffff' },
          jsPDF: { unit:'mm', format:'a4', orientation:'portrait' },
          pagebreak: { mode:['css','legacy'] }
        };

        // Generate
        const worker = html2pdf().set(opt).from(element).toPdf();
        const pdf = await worker.get('pdf');

        // Add page numbers footer (overlay) on each page
        const total = pdf.internal.getNumberOfPages();
        for(let i=1;i<=total;i++){
          pdf.setPage(i);
          pdf.setFontSize(9);
          pdf.setTextColor(120);
          const text = `Page ${i} of ${total}`;
          const pageWidth = pdf.internal.pageSize.getWidth();
          // Draw centered at bottom margin
          pdf.text(text, pageWidth - 20, pdf.internal.pageSize.getHeight() - 6, { align:'right' });
        }

        pdf.save(opt.filename);
      }catch(e){
        console.error(e);
        showAlert(errAlert, 'Could not generate PDF. Please try again.');
      }
    });

    function buildPdfFromData(inv, co){
      const number = inv.number || `INV-${(inv.id||'').slice(-6).toUpperCase()}`;
      const created = asDate(inv.createdAt);
      const due = asDate(inv.dueDate);
      const status = resolvedStatus(inv);
      const c = inv.customer || {};
      const full = c.fullName || [c.firstName,c.lastName].filter(Boolean).join(' ') || '';

      // Company
      document.getElementById('pdfCompanyName').textContent = co?.name || 'Building Group';
      document.getElementById('pdfCompanyAddress').textContent = co?.address || '';
      document.getElementById('pdfCompanyPhone').textContent = co?.phone || '';
      document.getElementById('pdfCompanyEmail').textContent = co?.email || '';
      document.getElementById('pdfCompanyWebsite').textContent = co?.website || '';
      document.getElementById('pdfCompanyVat').textContent = co?.vat || '';
      document.getElementById('pdfCompanyReg').textContent = co?.reg || '';

      // Header / meta
      document.getElementById('pdfNumber').textContent = number;
      document.getElementById('pdfInvNumber').textContent = number;
      document.getElementById('pdfInvDate').textContent = created ? created.toLocaleDateString() : '—';
      document.getElementById('pdfInvDue').textContent = due ? due.toLocaleDateString() : '—';
      document.getElementById('pdfInvStatus').textContent = status.toUpperCase();
      document.getElementById('pdfInvJob').textContent = inv.jobTitle ? `${inv.jobTitle}${inv.jobId?` (${inv.jobId})`:''}` : (inv.jobId || '—');

      // Bill to
      document.getElementById('pdfBillName').textContent = full || '—';
      document.getElementById('pdfBillEmail').textContent = c.email || '—';
      document.getElementById('pdfBillPhone').textContent = c.phone || '—';
      document.getElementById('pdfBillAddress').textContent = c.address || '—';

      // Items
      const tbody = document.getElementById('pdfItemsBody');
      tbody.innerHTML = '';
      const items = Array.isArray(inv.items) ? inv.items : [];
      if(items.length){
        items.forEach(it=>{
          const tr = document.createElement('tr');
          const qty = Number(it.quantity||0);
          const rate = Number(it.rate||0);
          const line = Number(it.total ?? (qty*rate)) || 0;
          tr.innerHTML = `
            <td><strong>${escapeHtml(it.item || it.name || 'Item')}</strong><br><span style="color:#6c757d">${escapeHtml(it.description || '')}</span></td>
            <td class="num">${qty}</td>
            <td class="num">${rate.toFixed(2)}</td>
            <td class="num">${line.toFixed(2)}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        const subtotal = parseFloat(inv.subtotal ?? inv.amount ?? 0) || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${escapeHtml(inv.title || inv.jobTitle || 'Invoice Amount')}</strong><br><span style="color:#6c757d">${escapeHtml(inv.description || 'Summary')}</span></td>
          <td class="num">1</td>
          <td class="num">${subtotal.toFixed(2)}</td>
          <td class="num">${subtotal.toFixed(2)}</td>
        `;
        tbody.appendChild(tr);
      }

      // Totals
      const totals = computeTotals();
      const paidAmt = parseFloat(inv.paidAmount||0)||0;
      const balance = +(totals.total - paidAmt).toFixed(2);

      document.getElementById('pdfSubtotal').textContent = money(totals.subtotal);
      document.getElementById('pdfTax').textContent = money(totals.tax);
      document.getElementById('pdfTotal').textContent = money(totals.total, {minimumFractionDigits:2, maximumFractionDigits:2});
      document.getElementById('pdfPaid').textContent = money(paidAmt);
      document.getElementById('pdfBalance').textContent = money(balance);

      // Notes / Payment
      const notes = (inv.notes || inv.publicNotes || inv.internalNotes || '').trim();
      document.getElementById('pdfNotes').textContent = notes || 'Thank you for your business.';
      document.getElementById('pdfPayInstructions').textContent = (co?.payInstructions || 'Please pay by bank transfer and include the invoice number as reference.').trim();
    }

    // Print
    printBtn.addEventListener('click', ()=>window.print());

    deleteBtn.addEventListener('click', async ()=>{
      if(!confirm('Delete this invoice? This cannot be undone.')) return;
      try{
        await db.collection('users').doc(currentUser.uid).collection('invoices').doc(invoiceId).delete();
        showAlert(okAlert,'Invoice deleted');
        setTimeout(()=>location.href='/account/invoices.html', 700);
      }catch(e){ console.error(e); showAlert(errAlert,'Failed to delete'); }
    });

    // Init
    document.addEventListener('DOMContentLoaded', async ()=>{
      invoiceId = getParamOrStorage();
      if(!invoiceId){
        showAlert(errAlert,'Missing invoice ID');
        setTimeout(()=>location.href='/account/invoices.html',1200);
        return;
      }
      const ok = await checkAuth();
      if(!ok) return;
      await loadInvoice();
    });
  </script>
</body>
</html>
